<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡å­è¦ªéŠ ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF8BA7;   /* æ«»èŠ±ç²‰ */
            --secondary: #FFC6C7; /* æ·ºç²‰ */
            --text: #4A4A4A;
            --bg: #FFF9FA;
            --white: #FFFFFF;
            --accent-food: #FF9800; /* ç¾é£Ÿæ©˜ */
            --accent-spot: #4CAF50; /* æ™¯é»ç¶  */
            --accent-trans: #2196F3; /* äº¤é€šè— */
            --font-scale: 1; /* å­—é«”ç¸®æ”¾è®Šæ•¸ */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px;
            font-size: calc(16px * var(--font-scale)); /* å‹•æ…‹å­—é«” */
        }

        #app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }

        /* --- Header --- */
        header {
            background: var(--primary); color: var(--white);
            padding: 15px; text-align: center;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        h1 { margin: 0; font-size: 1.3rem; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: white; }

        /* --- åˆ†é åˆ‡æ› --- */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        /* --- å­—é«”æ”¾å¤§æŒ‰éˆ• (æ‡¸æµ®) --- */
        #font-toggle {
            position: fixed; bottom: 100px; right: 20px;
            background: var(--white); color: var(--text);
            width: 50px; height: 50px; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.5rem; z-index: 99; cursor: pointer; border: 2px solid var(--primary);
        }

        /* --- å¤©æ°£ & ç©¿æ­ --- */
        .weather-banner {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border-radius: 15px; padding: 15px; margin-bottom: 20px;
            display: flex; align-items: center; justify-content: space-between;
            color: #1565C0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .weather-main { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: bold; }
        .clothing-tips { font-size: 0.9rem; margin-top: 5px; background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 20px; }

        /* --- è¡Œç¨‹å¡ç‰‡ (åˆ†é¡è¨­è¨ˆ) --- */
        .timeline-date {
            font-size: 1.2rem; font-weight: bold; color: var(--primary);
            margin: 20px 0 10px 0; border-bottom: 2px dashed var(--secondary); padding-bottom: 5px;
        }
        .card {
            background: var(--white); border-radius: 16px;
            margin-bottom: 15px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            position: relative; overflow: hidden;
            border-left: 6px solid #ccc;
        }
        .card.food { border-left-color: var(--accent-food); }
        .card.spot { border-left-color: var(--accent-spot); }
        .card.trans { border-left-color: var(--accent-trans); }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .time-badge { background: #eee; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .card-title { font-size: 1.2rem; font-weight: bold; margin: 10px 0 5px 0; }
        .card-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 8px; }
        .tag { font-size: 0.8rem; padding: 2px 8px; border-radius: 12px; font-weight: bold; }
        .tag.must-eat { background: #FFF3E0; color: #E65100; border: 1px solid #FFE0B2; }
        .tag.must-buy { background: #F3E5F5; color: #8E24AA; border: 1px solid #E1BEE7; }
        .tag.reserve { background: #FFEBEE; color: #C62828; border: 1px solid #FFCDD2; }

        .card-desc { font-size: 1rem; color: #666; line-height: 1.6; }
        .card-img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; margin-top: 10px; }
        .map-btn {
            display: inline-block; background: #E8F5E9; color: #2E7D32;
            padding: 6px 12px; border-radius: 20px; text-decoration: none;
            font-size: 0.9rem; margin-top: 10px; font-weight: bold;
        }
        
        /* --- è¨˜å¸³æœ¬ --- */
        .budget-summary {
            background: var(--white); padding: 20px; border-radius: 15px;
            text-align: center; margin-bottom: 20px; border: 2px solid var(--secondary);
        }
        .input-group { background: var(--white); padding: 15px; border-radius: 15px; margin-bottom: 20px; }
        input, select, textarea {
            width: 100%; padding: 12px; margin-bottom: 10px;
            border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box;
        }
        .btn-camera {
            background: #E0F7FA; color: #006064; border: 1px dashed #00ACC1;
            width: 100%; padding: 15px; border-radius: 10px; cursor: pointer;
            text-align: center; margin-bottom: 10px; display: block;
        }
        .btn-submit {
            background: var(--primary); color: white; border: none;
            width: 100%; padding: 12px; border-radius: 10px; font-size: 1.1rem;
        }
        .receipt-img-preview { max-width: 100%; max-height: 150px; border-radius: 8px; display: none; margin-bottom: 10px; }

        /* --- è³‡è¨Šé  (Info) --- */
        .info-card { background: var(--white); padding: 15px; border-radius: 15px; margin-bottom: 15px; }
        .info-label { font-size: 0.9rem; color: #888; }
        .info-val { font-size: 1.2rem; font-weight: bold; color: #333; margin-bottom: 5px; }
        .copy-btn { font-size: 0.8rem; background: #eee; border:none; padding: 2px 8px; border-radius: 4px; cursor: pointer; }

        /* --- å°èˆªåˆ— --- */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; max-width: 480px;
            background: var(--white); height: 70px; display: flex;
            border-top: 1px solid #eee; z-index: 100;
        }
        .nav-item { flex: 1; text-align: center; color: #999; padding-top: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }

    </style>
</head>
<body>

<div id="app">
    <header>
        <button class="icon-btn" onclick="toggleAdmin()">âš™ï¸</button>
        <h1>ç¦å²¡å­è¦ªéŠ ğŸŒ¸</h1>
        <button class="icon-btn" onclick="window.open('https://translate.google.com/?sl=ja&tl=zh-TW&op=translate', '_blank')">ğŸˆšï¸</button>
    </header>

    <div id="font-toggle" onclick="toggleFontSize()">A+</div>

    <div id="p-schedule" class="page active">
        <div class="weather-banner" id="weather-banner">
            <div>
                <div class="weather-main" id="w-temp">--Â°C</div>
                <div id="w-loc">æ­£åœ¨é€£ç·šæ°£è±¡...</div>
            </div>
            <div style="text-align:right;">
                <div id="w-icon" style="font-size:2.5rem;">â˜ï¸</div>
                <div class="clothing-tips" id="w-tips">ç©¿æ­å»ºè­°è¼‰å…¥ä¸­</div>
            </div>
        </div>

        <div id="schedule-container"></div>
        
        <div id="admin-tools" style="display:none; text-align:center; margin-top:20px;">
            <button onclick="initData()" style="background:#4CAF50; color:white; padding:10px; border:none; border-radius:5px;">ğŸ“¥ é‡ç½®/è¼‰å…¥é è¨­è¡Œç¨‹</button>
        </div>
    </div>

    <div id="p-money" class="page">
        <div class="info-card" style="background:#E3F2FD;">
            <h3>âœ… å·²ä»˜æ¬¾é …ç›® (å›ºå®š)</h3>
            <div id="prepaid-list"></div>
        </div>

        <div class="budget-summary">
            <div>ç¸½èŠ±è²» (å«ç¾é‡‘/åˆ·å¡)</div>
            <div id="total-display" style="font-size:2rem; font-weight:bold; color:#E91E63;">NT$ 0</div>
            <div style="font-size:0.9rem; color:#666;">åŒ¯ç‡è¨­å®š: 0.22</div>
        </div>

        <div class="input-group">
            <h3>â• æ–°å¢æ¶ˆè²»</h3>
            <input type="text" id="exp-name" placeholder="å“é …åç¨± (å¦‚: æ‹‰éºµ)">
            <div style="display:flex; gap:10px;">
                <select id="exp-cat">
                    <option value="food">é¤é£²</option>
                    <option value="shopping">è³¼ç‰©</option>
                    <option value="transport">äº¤é€š</option>
                    <option value="drug">è—¥å¦</option>
                    <option value="hotel">ä½å®¿</option>
                    <option value="other">å…¶ä»–</option>
                </select>
                <select id="exp-pay">
                    <option value="cash">ç¾é‡‘</option>
                    <option value="card">åˆ·å¡</option>
                    <option value="ic">è¥¿ç“œå¡</option>
                </select>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
                <input type="number" id="exp-amt" placeholder="é‡‘é¡" style="margin:0;">
                <select id="exp-curr" style="width:80px; margin:0;" onchange="calcRate()">
                    <option value="JPY">JPY</option>
                    <option value="TWD">TWD</option>
                </select>
            </div>
            <div id="rate-calc" style="text-align:right; color:#888; margin-bottom:10px;">ç´„å°å¹£ 0 å…ƒ</div>

            <label class="btn-camera">
                ğŸ“· æ‹æ”¶æ“š / ä¸Šå‚³ç…§ç‰‡
                <input type="file" id="exp-img-file" accept="image/*" style="display:none;" onchange="previewImage(this)">
            </label>
            <img id="img-preview" class="receipt-img-preview">

            <button class="btn-submit" id="btn-save-exp">è¨˜å¸³</button>
        </div>

        <div id="expense-list"></div>
    </div>

    <div id="p-info" class="page">
        <div class="info-card">
            <h3>âœˆï¸ èˆªç­è³‡è¨Š</h3>
            <div class="info-label">å»ç¨‹ (è™èˆª IT240)</div>
            <div class="info-val">1/13 06:45 TPE â” 10:00 FUK</div>
            <hr style="border:0; border-top:1px dashed #eee; margin:10px 0;">
            <div class="info-label">å›ç¨‹ (è™èˆª IT241)</div>
            <div class="info-val">1/17 10:55 FUK â” 12:40 TPE</div>
        </div>
        <div class="info-card">
            <h3>ğŸ¨ ä½å®¿è³‡è¨Š</h3>
            <div class="info-label">Day 1: ç”±å¸ƒé™¢å±±æ°´é¤¨</div>
            <div class="info-val">0977-84-2101 <button class="copy-btn" onclick="alert('å·²è¤‡è£½')">è¤‡è£½</button></div>
            <div style="margin-top:5px;"><a href="https://goo.gl/maps/xyz" target="_blank">ğŸ“ é–‹å•Ÿåœ°åœ–</a></div>
            <hr style="border:0; border-top:1px dashed #eee; margin:10px 0;">
            <div class="info-label">Day 2-4: ä¸‰äº•èŠ±åœ’é£¯åº—ç¦å²¡ä¸­æ´²</div>
            <div class="info-val">092-283-3131 <button class="copy-btn" onclick="alert('å·²è¤‡è£½')">è¤‡è£½</button></div>
            <div style="margin-top:5px;"><a href="https://goo.gl/maps/abc" target="_blank">ğŸ“ é–‹å•Ÿåœ°åœ–</a></div>
        </div>
        <div class="info-card" style="border-left:5px solid red;">
            <h3>ğŸ†˜ ç·Šæ€¥è¯çµ¡</h3>
            <div class="info-label">æ—…å¤–åœ‹äººæ€¥é›£æ•‘åŠ©</div>
            <div class="info-val" style="color:red;">080-1004-0243</div>
            <a href="tel:+818010040243" class="map-btn" style="background:#FFEBEE; color:red;">ğŸ“ æ’¥æ‰“é›»è©±</a>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('schedule', this)">
            <span class="nav-icon">ğŸ“…</span>è¡Œç¨‹
        </div>
        <div class="nav-item" onclick="switchPage('money', this)">
            <span class="nav-icon">ğŸ’´</span>è¨˜å¸³
        </div>
        <div class="nav-item" onclick="switchPage('info', this)">
            <span class="nav-icon">â„¹ï¸</span>è³‡è¨Š
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, setDoc } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

   // â†“â†“â†“ è«‹è²¼ä¸Šæ‚¨çš„ Firebase Config â†“â†“â†“
const firebaseConfig = {
  apiKey: "AIzaSyDZzgq0W4xdHIhf6H1xC_dEScEHmAnXtiE",
  authDomain: "fukuokagina2026.firebaseapp.com",
  projectId: "fukuokagina2026",
  storageBucket: "fukuokagina2026.firebasestorage.app",
  messagingSenderId: "762021519656",
  appId: "1:762021519656:web:15c443c2ca2f13f9bc701d"
    };
    // â†‘â†‘â†‘ End Config â†‘â†‘â†‘


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const RATE = 0.22; 

    // --- å…¨å±€è®Šæ•¸ ---
    let fontSize = 1;
    window.toggleFontSize = () => {
        fontSize = fontSize === 1 ? 1.3 : 1; // 1.3å€æ”¾å¤§
        document.documentElement.style.setProperty('--font-scale', fontSize);
    };

    // --- 1. è¡Œç¨‹é‚è¼¯ (Firebase) ---
    // é è¨­è³‡æ–™ (åŒ…å«æ‚¨æä¾›çš„è©³ç´°ä»‹ç´¹ & AI æ¨¡æ“¬æ¨™ç±¤)
    const initialData = [
        { day: "Day 1", time: "11:45", title: "å¿…åƒã€Œå¤§å±±ã€ç‰›é›œé‹", type: "food", desc: "åšå¤šéˆé­‚ç¾é£Ÿï¼ç‰›è…¸è»Ÿå«©ã€å‘³å™Œæ¿ƒéƒã€‚", tags: ["must-eat"], tips: "âš ï¸ åœ‹å…§ç·š3Fï¼Œæ’éšŠäººå¤š", loc: "åšå¤šã‚‚ã¤é‹ãŠãŠã‚„ã¾ ç¦å²¡ç©ºæ¸¯", img: "https://ginalitw.github.io/fukuoka-app/images/0101.png" },
        { day: "Day 1", time: "13:12", title: "é«˜é€Ÿå·´å£«å¾€ç”±å¸ƒé™¢", type: "trans", desc: "åœ‹å…§ç·š2è™Ÿç«™ç‰Œæ­ä¹˜ã€Œæ¹¯å¸ƒé™¢è™Ÿã€ã€‚", tags: ["reserve"], tips: "âš ï¸ é ç´„ä»£è™Ÿè«‹æˆªåœ–", loc: "ç¦å²¡æ©Ÿå ´å·´å£«ç«™", img: "https://ginalitw.github.io/fukuoka-app/images/0102.jpg" },
        { day: "Day 1", time: "15:00", title: "å…¥ä½ï¼šç”±å¸ƒé™¢å±±æ°´é¤¨", type: "spot", desc: "æ›æµ´è¡£çœ‹å±±æ™¯ï¼Œäº«å—éœ²å¤©æº«æ³‰ã€‚", tags: [], tips: "ğŸ§¥ å±±å€è¼ƒå†·ï¼Œå¸¶è–„å¤–å¥—", loc: "ç”±å¸ƒé™¢å±±æ°´é¤¨", img: "https://ginalitw.github.io/fukuoka-app/images/0103.jpg" },
        { day: "Day 2", time: "10:30", title: "é‡‘é±—æ¹–æ•£ç­–", type: "spot", desc: "æ™¨éœ§å¤¢å¹»ç¾æ™¯ï¼Œå¿…æ‹å€’å½±ã€‚", tags: ["spot"], tips: "ğŸ‘Ÿ èµ°è·¯è¡Œç¨‹ï¼Œç©¿å¥½èµ°çš„é‹", loc: "é‡‘é±—æ¹–", img: "https://ginalitw.github.io/fukuoka-app/images/0104.jpg" },
        { day: "Day 2", time: "17:11", title: "ç”±å¸ƒé™¢ä¹‹æ£®", type: "trans", desc: "å¤¢å¹»ç¶ è‰²ç‰¹æ€¥åˆ—è»Šï¼Œè»Šå»‚è¶…ç¾ã€‚", tags: ["must-buy"], tips: "ğŸ± å¿…è²·è»Šä¸Šä¾¿ç•¶", loc: "ç”±å¸ƒé™¢é§…", img: "https://ginalitw.github.io/fukuoka-app/images/0105.jpg" },
        { day: "Day 4", time: "10:00", title: "å”æˆ¶å¸‚å ´", type: "food", desc: "é€±äº”é™å®šé¦¬é—œè¡—ï¼å£½å¸è‡ªåŠ©é¤ã€‚", tags: ["must-eat"], tips: "ğŸ’¨ æµ·é‚Šé¢¨å¤§ï¼Œè¨˜å¾—æˆ´å¸½å­", loc: "å”æˆ¶å¸‚å ´", img: "https://placehold.co/600x400/FF69B4/white?text=Sushi" }
    ];

    // åˆå§‹åŒ–è³‡æ–™åº« (æŒ‰éˆ•è§¸ç™¼)
    window.initData = async () => {
        if(!confirm("é€™æœƒé‡ç½®è¡Œç¨‹è¡¨ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
        // é€™è£¡ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘ç”¨ addDoc é€ç­†åŠ å…¥ï¼Œå¯¦éš›ä½¿ç”¨å»ºè­°å…ˆæ¸…ç©ºå†åŠ 
        for(let item of initialData) {
            await addDoc(collection(db, "schedule"), item);
        }
        alert("è³‡æ–™å·²è¼‰å…¥ï¼");
    };

    // ç›£è½è¡Œç¨‹æ›´æ–°
    const qSch = query(collection(db, "schedule"), orderBy("day"), orderBy("time"));
    onSnapshot(qSch, (snapshot) => {
        const container = document.getElementById("schedule-container");
        let html = "";
        let currentDay = "";

        snapshot.forEach((doc) => {
            const data = doc.data();
            
            // æ—¥æœŸåˆ†éš”ç·š
            if (data.day !== currentDay) {
                currentDay = data.day;
                html += `<div class="timeline-date">${currentDay}</div>`;
                // é€™è£¡è§¸ç™¼å¤©æ°£æ›´æ–° (ç°¡åŒ–ç‰ˆï¼šåªæŠ“ç¬¬ä¸€ç­†çš„ day)
                updateWeather(currentDay); 
            }

            // æ¨™ç±¤è™•ç†
            let tagsHtml = "";
            if(data.tags && data.tags.includes("must-eat")) tagsHtml += `<span class="tag must-eat">âœ¨ å¿…åƒ</span>`;
            if(data.tags && data.tags.includes("must-buy")) tagsHtml += `<span class="tag must-buy">ğŸ›ï¸ å¿…è²·</span>`;
            if(data.tags && data.tags.includes("reserve")) tagsHtml += `<span class="tag reserve">âš ï¸ é ç´„</span>`;

            // å¡ç‰‡ HTML
            html += `
            <div class="card ${data.type}">
                <div class="card-header">
                    <span class="time-badge">${data.time}</span>
                    <button class="icon-btn" style="color:#ccc; font-size:1rem;" onclick="deleteSchedule('${doc.id}')">ğŸ—‘ï¸</button>
                </div>
                <div class="card-title">${data.title}</div>
                <div class="card-tags">${tagsHtml}</div>
                <div class="card-desc">${data.desc}</div>
                ${data.tips ? `<div style="margin-top:5px; font-size:0.9rem; color:#E65100;">ğŸ’¡ ${data.tips}</div>` : ''}
                ${data.img ? `<img src="${data.img}" class="card-img" loading="lazy">` : ''}
                <a href="https://www.google.com/maps/search/?api=1&query=${data.loc}+ç¦å²¡" target="_blank" class="map-btn">ğŸ“ Google å°èˆª</a>
            </div>`;
        });
        container.innerHTML = html || "<div style='text-align:center; padding:20px;'>è¼‰å…¥ä¸­æˆ–å°šç„¡è¡Œç¨‹...<br>(ç®¡ç†è€…è«‹æŒ‰ä¸‹æ–¹åˆå§‹åŒ–)</div>";
    });

    // --- 2. è¨˜å¸³é‚è¼¯ (å«ç…§ç‰‡ä¸Šå‚³) ---
    // é ä»˜æ¸…å–®
    const prepaidList = [
        { name: "æ©Ÿç¥¨ (è™èˆª)", amt: 41490 },
        { name: "Klook ä¸€æ—¥éŠ", amt: 4239 },
        { name: "JR ç”±å¸ƒé™¢ä¹‹æ£®", amt: 3862 },
        { name: "è»Šä¸Šä¾¿ç•¶", amt: 1260 }
    ];
    
    function renderPrepaid() {
        let html = "";
        let total = 0;
        prepaidList.forEach(p => {
            total += p.amt;
            html += `<div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding:5px 0;">
                <span>${p.name}</span> <span style="font-weight:bold;">$${p.amt.toLocaleString()}</span>
            </div>`;
        });
        document.getElementById("prepaid-list").innerHTML = html;
        return total;
    }

    // å„²å­˜æ¶ˆè²»
    document.getElementById("btn-save-exp").addEventListener("click", async () => {
        const btn = document.getElementById("btn-save-exp");
        btn.innerText = "â³ å„²å­˜ä¸­...";
        btn.disabled = true;

        try {
            const name = document.getElementById("exp-name").value;
            const cat = document.getElementById("exp-cat").value;
            const pay = document.getElementById("exp-pay").value;
            const curr = document.getElementById("exp-curr").value;
            const amt = parseFloat(document.getElementById("exp-amt").value);
            const file = document.getElementById("exp-img-file").files[0];

            if(!name || !amt) throw new Error("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

            // 1. å¦‚æœæœ‰ç…§ç‰‡ï¼Œå…ˆä¸Šå‚³ Storage
            let imgUrl = "";
            if (file) {
                const storageRef = ref(storage, 'receipts/' + new Date().getTime() + '_' + file.name);
                await uploadBytes(storageRef, file);
                imgUrl = await getDownloadURL(storageRef);
            }

            // 2. å­˜å…¥ Firestore
            await addDoc(collection(db, "expenses"), {
                item: name, category: cat, payment: pay, 
                currency: curr, amount: amt, 
                img: imgUrl, timestamp: new Date()
            });

            // é‡ç½®
            document.getElementById("exp-name").value = "";
            document.getElementById("exp-amt").value = "";
            document.getElementById("exp-img-file").value = ""; // æ¸…ç©ºæª”æ¡ˆ
            document.getElementById("img-preview").style.display = "none";
            alert("è¨˜å¸³æˆåŠŸï¼");

        } catch (e) {
            alert("éŒ¯èª¤ï¼š" + e.message);
            console.error(e);
        } finally {
            btn.innerText = "è¨˜å¸³";
            btn.disabled = false;
        }
    });

    // é¡¯ç¤ºè¨˜å¸³åˆ—è¡¨
    const qExp = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
    onSnapshot(qExp, (snapshot) => {
        const list = document.getElementById("expense-list");
        let prepaidTotal = renderPrepaid();
        let dynTotal = 0;
        let html = "";

        snapshot.forEach((doc) => {
            const data = doc.data();
            // æ›ç®—å°å¹£
            let twd = data.currency === "JPY" ? Math.round(data.amount * RATE) : data.amount;
            dynTotal += twd;

            html += `
            <div style="background:white; padding:10px; border-radius:10px; margin-bottom:10px; border-left:4px solid #FF9800; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold;">${data.item}</div>
                    <div style="font-size:0.8rem; color:#888;">${data.payment} Â· ${data.category}</div>
                    ${data.img ? `<a href="${data.img}" target="_blank" style="font-size:0.8rem; color:#2196F3;">ğŸ“„ æŸ¥çœ‹æ”¶æ“š</a>` : ''}
                </div>
                <div style="text-align:right;">
                    <div style="color:#E91E63; font-weight:bold;">NT$ ${twd}</div>
                    ${data.currency==='JPY' ? `<div style="font-size:0.8rem; color:#aaa;">Â¥${data.amount}</div>` : ''}
                    <button onclick="deleteExpense('${doc.id}')" style="font-size:0.8rem; color:red; border:none; background:none;">åˆªé™¤</button>
                </div>
            </div>`;
        });

        list.innerHTML = html;
        document.getElementById("total-display").innerText = "NT$ " + (prepaidTotal + dynTotal).toLocaleString();
    });

    // --- å·¥å…·å‡½å¼ ---
    window.previewImage = (input) => {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById("img-preview");
                img.src = e.target.result;
                img.style.display = "block";
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    window.calcRate = () => {
        const amt = document.getElementById("exp-amt").value;
        const curr = document.getElementById("exp-curr").value;
        const disp = document.getElementById("rate-calc");
        if(curr === "JPY") disp.innerText = `ç´„å°å¹£ ${Math.round(amt * RATE)} å…ƒ`;
        else disp.innerText = "å°å¹£è¨ˆåƒ¹";
    }

    window.updateWeather = async (day) => {
        // ç°¡æ˜“æ¨¡æ“¬ï¼šå¯¦éš›å¯æ¥ Open-Meteo
        // é€™è£¡ç¤ºç¯„å¦‚ä½•æ ¹æ“šè¡Œç¨‹åœ°é»è®Šæ›´å»ºè­°
        const tipsEl = document.getElementById("w-tips");
        const locEl = document.getElementById("w-loc");
        
        if(day.includes("Day 1")) {
            locEl.innerText = "ç¦å²¡å¸‚"; 
            tipsEl.innerText = "ğŸ§¥ æ°£æº«ç´„ 10åº¦ï¼Œå¾®æ¶¼è«‹å¸¶å¤–å¥—";
        } else if (day.includes("Day 2")) {
            locEl.innerText = "ç”±å¸ƒé™¢"; 
            tipsEl.innerText = "â„ï¸ å±±å€æ¸…æ™¨æ¥è¿‘0åº¦ï¼Œå‹™å¿…ç©¿ç™¼ç†±è¡£ï¼";
        } else if (day.includes("Day 4")) {
            locEl.innerText = "å”æˆ¶å¸‚å ´ (æµ·é‚Š)"; 
            tipsEl.innerText = "ğŸ’¨ æµ·é¢¨éå¸¸å¤§ï¼å¸½å­è¦æˆ´å¥½ï¼Œæ³¨æ„ä¿æš–";
        }
    }

    window.deleteExpense = async (id) => { if(confirm("åˆªé™¤?")) await deleteDoc(doc(db, "expenses", id)); };
    window.deleteSchedule = async (id) => { if(confirm("åˆªé™¤è¡Œç¨‹?")) await deleteDoc(doc(db, "schedule", id)); };

    window.toggleAdmin = () => {
        const el = document.getElementById("admin-tools");
        el.style.display = el.style.display === "none" ? "block" : "none";
    };

    window.switchPage = (id, btn) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('p-' + id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    };
</script>
</body>
</html>
