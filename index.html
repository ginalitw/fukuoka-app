<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¦å²¡å¥½å¥½ç© V36 ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF8BA7;
            --bg-color: #F8F9FA;
            --white: #FFFFFF;
            --text-main: #2D3436;
            --accent-food: #FF9800; 
            --accent-spot: #4CAF50; 
            --accent-trans: #2196F3;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-main);
            margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; font-size: 16px;
        }
        #app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; background: #fff; }

        /* Header */
        header {
            background: rgba(255, 139, 167, 0.95); backdrop-filter: blur(10px); color: white;
            padding: 15px 20px; text-align: center; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(255, 139, 167, 0.3); display: flex; justify-content: space-between; align-items: center;
        }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 700; }
        .icon-btn { background: rgba(255,255,255,0.25); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 1.2rem; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; }

        /* å€’æ•¸è¨ˆæ™‚ */
        #countdown-bar { background: #FFF3E0; color: #E65100; text-align: center; padding: 10px; font-weight: bold; font-size: 1.1rem; border-bottom: 1px solid #FFCC80; }

        /* Page System */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: 0; } }

        /* Tools Grid */
        .tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .tool-card {
            background: white; border-radius: 16px; padding: 20px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 2px solid #eee; cursor: pointer;
            transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 110px; position: relative;
        }
        .tool-card:active { transform: scale(0.95); background: #FFF0F5; border-color: var(--primary); }
        .tool-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .tool-name { font-weight: bold; color: #555; }

        /* Sub Page */
        .sub-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 200; display: none; flex-direction: column; overflow-y: auto; }
        .sub-header { background: white; padding: 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 201; }
        .back-btn { font-size: 1.5rem; background: none; border: none; margin-right: 15px; cursor: pointer; padding: 5px; }
        .sub-content { padding: 20px; padding-bottom: 100px; }

        /* Checklist */
        .checklist-item { background: white; padding: 15px; margin-bottom: 10px; border-radius: 12px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); cursor: pointer; }
        .checklist-item.checked { opacity: 0.5; background: #f0f0f0; }
        .checklist-item.checked .cb-text { text-decoration: line-through; }
        .cb-icon { font-size: 1.2rem; margin-right: 15px; color: #ccc; width: 24px; text-align: center;}
        .checklist-item.checked .cb-icon { color: var(--accent-spot); content: "âœ”"; }

        /* Wishlist */
        .wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
        .wish-item { position: relative; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); background: white; padding-bottom: 5px; }
        .wish-img { width: 100%; height: 150px; object-fit: cover; display: block; cursor: zoom-in; }
        .wish-info { padding: 10px; }
        .wish-title { font-size: 1rem; font-weight: bold; color: #333; margin-bottom: 5px; }
        .wish-note { font-size: 0.85rem; color: #666; margin-bottom: 8px; white-space: pre-line; }
        .wish-del { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; line-height: 24px; font-size: 0.8rem; cursor: pointer; z-index: 10; }
        .tool-actions { display: flex; gap: 5px; }
        .tool-link-btn, .tool-map-btn { flex: 1; display: block; text-align: center; text-decoration: none; padding: 6px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; }
        .tool-link-btn { background: #E3F2FD; color: #1565C0; }
        .tool-map-btn { background: #E8F5E9; color: #2E7D32; }

        /* Expense */
        .info-card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .input-box { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; border: 2px solid var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input, select, textarea { width: 100%; padding: 15px; margin-bottom: 12px; border: 1px solid #dfe6e9; border-radius: 12px; font-size: 1.1rem; box-sizing: border-box; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; border: none; width: 85%; padding: 15px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; display: block; margin: 15px auto; box-shadow: 0 4px 10px rgba(255, 139, 167, 0.4); cursor: pointer; }
        .btn-outline { background: white; border: 2px solid #dfe6e9; color: #636E72; width: 85%; padding: 10px; border-radius: 30px; font-size: 1rem; font-weight: bold; cursor: pointer; margin: 10px auto; text-align: center; display: block;}
        .expense-item { background: white; padding: 18px; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 6px solid #FF9800; font-size: 1.1rem; }
        .prepaid-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; color: #555; }
        .prepaid-row:last-child { border-bottom: none; }
        #split-section { display: none; }
        .split-dashboard { background: #FFF8E1; border: 2px solid #FFE082; border-radius: 16px; padding: 20px; margin-bottom: 25px; }
        .split-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1.1rem; border-bottom: 1px dashed #ccc; padding-bottom: 8px; }
        .split-owe { color: #e74c3c; font-weight: bold; }
        .split-get { color: #27ae60; font-weight: bold; }

        /* Carousel */
        .carousel-container { position: relative; width: 100%; height: 240px; overflow: hidden; background: #eee; margin-bottom: 10px; }
        .carousel-track { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; width: 100%; height: 100%; -webkit-overflow-scrolling: touch; }
        .carousel-track::-webkit-scrollbar { display: none; }
        .carousel-slide { flex: 0 0 100%; width: 100%; height: 100%; scroll-snap-align: center; position: relative; }
        .carousel-img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-btn { position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 5px; }
        .carousel-del { position: absolute; top: 10px; right: 10px; background: rgba(255,0,0,0.7); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: none; }
        .carousel-slide:hover .carousel-del { display: flex; justify-content: center; align-items: center; }

        /* Album Link */
        .album-link-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: white; border: 2px solid #4285F4; color: #4285F4; margin: 15px 15px; padding: 12px; border-radius: 12px; font-weight: bold; text-decoration: none; font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.1s; }
        .album-link-btn:active { background: #E8F0FE; transform: scale(0.98); }

        /* Schedule */
        #p-schedule { padding: 0; } 
        #schedule-content-pad { padding: 0 15px 20px 15px; }
        .day-nav { display: flex; overflow-x: auto; white-space: nowrap; background: white; padding: 12px 15px; position: sticky; top: 0; z-index: 98; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .day-btn { background: #F1F2F6; border: none; padding: 8px 18px; margin-right: 8px; border-radius: 25px; color: #636E72; font-size: 1rem; cursor: pointer; }
        .day-btn.active { background: var(--primary); color: white; font-weight: bold; }
        .weather-banner { background: linear-gradient(135deg, #81D4FA, #29B6F6); border-radius: 16px; padding: 20px; display: flex; align-items: center; justify-content: space-between; color: white; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(41, 182, 246, 0.3); }
        .day-divider { margin: 30px 0 15px 0; font-weight: bold; color: #2196F3; border-bottom: 3px dashed #ccc; padding-bottom: 5px; font-size: 1.3rem; }
        .card { background: white; border-radius: 16px; margin-bottom: 20px; padding: 20px; box-shadow: 0 3px 10px rgba(0,0,0,0.08); border-left: 8px solid #ccc; cursor: pointer; }
        .card.food { border-left-color: var(--accent-food); } .card.spot { border-left-color: var(--accent-spot); } .card.trans { border-left-color: var(--accent-trans); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-title { font-size: 1.5rem; font-weight: 700; margin: 0 0 10px 0; color: #2D3436; line-height: 1.3; }
        .time-badge { background: #F1F2F6; padding: 5px 12px; border-radius: 8px; font-weight: 700; font-size: 1.1rem; color: #2D3436; }
        .card-desc { font-size: 1.15rem; color: #333; line-height: 1.8; white-space: pre-line; margin-bottom: 15px; }
        .card-img { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-top: 10px; display:block; background:#eee;}
        .btn-group { display: flex; gap: 15px; margin-top: 18px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 12px; text-align: center; text-decoration: none; font-size: 1rem; font-weight: 700; display: block; transition: transform 0.1s; }
        .btn-map { background: #E8F5E9; color: #27ae60; border: 1px solid #C8E6C9; }
        .btn-link { background: #E3F2FD; color: #0984e3; border: 1px solid #BBDEFB; }
        
        /* FAB */
        #add-fab { position: fixed; bottom: 100px; right: 20px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; font-size: 2.2rem; z-index: 99; cursor: pointer; border: none; display:none; }
        #btn-lock { position: fixed; bottom: 180px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background: white; border: 2px solid #ccc; z-index: 99; font-size: 1.4rem; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #btn-lock.unlocked { border-color: red; color: red; background: #FFEBEE; }

        /* Nav Bar */
        .nav-bar { position: fixed; bottom: 0; width: 100%; max-width: 480px; background: rgba(255,255,255,0.95); height: 80px; display: flex; border-top: 1px solid rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #B2BEC3; padding-top: 12px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-icon { font-size: 1.8rem; display: block; margin-bottom: 4px; }
        .nav-label { font-size: 0.9rem; }

        /* Modal */
        #modal, #modal-tool, #modal-link, #modal-lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 400px; padding: 25px; border-radius: 20px; max-height: 85vh; overflow-y: auto; }
        #lightbox-img { max-width: 90%; max-height: 80vh; border-radius: 8px; }
        
        .hl-food { background: #fff3cd; color: #856404; padding: 0 4px; border-radius: 4px; }
        .hl-buy { background: #e2e3f5; color: #383d41; padding: 0 4px; border-radius: 4px; }
        .hl-res { background: #f8d7da; color: #721c24; padding: 0 4px; border-radius: 4px; }

        /* åŒ¯ç‡è¨ˆç®—æ©Ÿ */
        .rate-calc-box { background: white; border: 2px solid var(--primary); border-radius: 16px; padding: 15px; margin: 15px; display: flex; align-items: center; justify-content: space-between; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .rate-input { width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 1.1rem; text-align: center; }
        .rate-result { font-size: 1.2rem; font-weight: bold; color: #2D3436; }
        .rate-setting { font-size: 0.8rem; color: #888; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div style="width:45px"></div>
        <h1>ç¦å²¡å¥½å¥½ç© ğŸŒ¸</h1>
        <button class="icon-btn" onclick="window.openTranslate()">ğŸˆšï¸</button>
    </header>
    
    <!-- è¨ˆæ™‚å™¨ -->
    <div id="countdown-bar"></div>

    <!-- 1. è¡Œç¨‹é  -->
    <div id="p-schedule" class="page active">
        <div class="carousel-container" style="position:relative; width:100%; height:240px; overflow:hidden; margin-bottom:10px;">
            <div id="carousel-track" style="width:100%; height:100%;">
                <img src="https://ginalitw.github.io/fukuoka-app/images/0104.jpg" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <label class="carousel-btn">ğŸ“· ä¸Šå‚³å°é¢ <input type="file" accept="image/*" style="display:none;" onchange="window.uploadBanner(this)"></label>
        </div>
        
        <a href="https://photos.app.goo.gl/ukaRg1J12MkCrYsw5" target="_blank" class="album-link-btn">ğŸ“‚ é–‹å•Ÿ Google å®Œæ•´ç›¸ç°¿ (å…±ç”¨)</a>

        <div id="schedule-content-pad" style="padding:0 15px 20px 15px;">
            <button id="add-fab" onclick="window.openEditModal(null)">+</button>
            <button id="btn-lock" onclick="window.toggleLock()">ğŸ”’</button>

            <div class="day-nav">
                <button class="day-btn active" onclick="window.filterDay('Day 1', this)">Day 1</button>
                <button class="day-btn" onclick="window.filterDay('Day 2', this)">Day 2</button>
                <button class="day-btn" onclick="window.filterDay('Day 3', this)">Day 3</button>
                <button class="day-btn" onclick="window.filterDay('Day 4', this)">Day 4</button>
                <button class="day-btn" onclick="window.filterDay('Day 5', this)">Day 5</button>
            </div>

            <div class="weather-banner">
                <div><div style="font-size:2rem; font-weight:bold;" id="w-temp">--Â°C</div><div id="w-loc" style="font-weight:500; opacity:0.9; font-size:1.1rem;">æ°£è±¡é€£ç·šä¸­...</div></div>
                <div style="text-align:right;"><div id="w-icon" style="font-size:3rem;">â˜ï¸</div><div style="font-size:1rem; font-weight:500;" id="w-tips">ç©¿æ­å»ºè­°</div></div>
            </div>

            <div id="schedule-container" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- 2. è¨˜å¸³é  -->
    <div id="p-money" class="page">
        <div class="page-content">
            <div class="rate-calc-box">
                <div><input type="number" id="calc-in-money" class="rate-input" placeholder="æ—¥å¹£" oninput="window.updateCalc('money')"> JPY</div>
                <div style="font-weight:bold;">=</div>
                <div><span id="calc-res-money" class="rate-result">0</span> TWD</div>
            </div>
            <div style="text-align:right; font-size:0.9rem; color:#888; margin-bottom:20px; padding-right:15px;">
                åŒ¯ç‡: <span id="rate-display-money">0.22</span> <span class="rate-setting" onclick="window.setRate()">[ä¿®æ”¹]</span>
            </div>

            <div class="info-card" style="text-align:center; border:2px solid var(--primary); background:#FFF0F5;">
                <div style="color:#666; margin-bottom:5px; font-size:1.1rem;">æ—…é€”ç¸½èŠ±è²» (å«å…¬è²»æ”¯å‡º)</div>
                <div id="total-display" style="font-size:2.2rem; font-weight:800; color:#D6336C;">è¨ˆç®—ä¸­...</div>
            </div>

            <div class="input-box">
                <h3 style="margin-top:0; text-align:center; color:var(--text-main);">â• æ–°å¢æ¶ˆè²»</h3>
                <div style="margin-bottom:15px; text-align:center;">
                    <label style="font-weight:bold; color:var(--primary); font-size:1.2rem;">èª°ä»˜çš„éŒ¢ï¼Ÿ</label><br>
                    <select id="exp-payer" style="width:70%; margin-top:5px; text-align:center; font-weight:bold; font-size:1.1rem;">
                        <option value="æˆ‘">æˆ‘</option><option value="èŠ¬">èŠ¬</option><option value="ç">ç</option><option value="å…¬è²»">ğŸ’° å…¬è²» (å¾å…¬æ¬¾æ‰£)</option>
                    </select>
                </div>
                <input type="text" id="exp-name" placeholder="å“é …åç¨± (å¦‚: æ‹‰éºµ)">
                <div style="display:flex; gap:10px;">
                    <select id="exp-cat"><option value="é¤é£²">é¤é£²</option><option value="äº¤é€š">äº¤é€š</option><option value="è³¼ç‰©">è³¼ç‰©</option><option value="å…¶ä»–">å…¶ä»–</option><option value="ç¹³å…¬è²»">ç¹³å…¬è²»</option></select>
                    <select id="exp-pay"><option value="ç¾é‡‘">ç¾é‡‘</option><option value="åˆ·å¡">åˆ·å¡</option></select>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="exp-amt" placeholder="ç¸½é‡‘é¡" style="font-weight:bold;">
                    <select id="exp-curr" style="width:90px;" onchange="window.calcRate()"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
                </div>
                <div id="rate-calc" style="text-align:right; color:#888; font-size:0.9rem; margin-bottom:15px;">ç´„å°å¹£ 0 å…ƒ</div>
                <label class="btn-outline">ğŸ“· æ‹ç…§ / ä¸Šå‚³æ”¶æ“š <input type="file" id="exp-img-file" accept="image/*" style="display:none;" onchange="window.previewImage(this)"></label>
                <img id="img-preview" style="width:100%; max-height:150px; object-fit:contain; display:none; margin-top:10px; border-radius:10px;">
                <button class="btn-primary" id="btn-save-exp" style="margin-top:15px;">è¨˜ä¸Šä¸€ç­†</button>
                <button onclick="window.exportExcel()" style="width:100%; background:#27ae60; color:white; border:none; padding:12px; border-radius:20px; font-weight:bold; margin-top:10px; font-size:1.1rem;">ğŸ“¥ åŒ¯å‡º Excel</button>
            </div>
            
            <h3 style="padding-left:15px; margin-bottom:15px; color:#2D3436;">ğŸ“‹ æ¶ˆè²»åˆ—è¡¨</h3>
            <div id="expense-list" style="padding-bottom:20px;"></div>
            
            <div class="info-card" style="background:#E3F2FD;">
                <h4 style="margin-top:0; color:#1565C0; font-size:1.1rem;">âœ… è¡Œå‰å·²ä»˜ (ä¸åˆ—å…¥åˆ†å¸³)</h4>
                <div id="prepaid-list"></div>
            </div>

            <button class="btn-outline" style="width:90%; margin:20px auto; background:#607D8B; color:white; border:none;" onclick="window.toggleSplit()">ğŸ“Š æŸ¥çœ‹åˆ†å¸³çµç®— (3äºº)</button>
            <div id="split-section">
                <div class="split-dashboard">
                    <div class="split-title">åˆ†å¸³çµç®— (å¤šé€€å°‘è£œ)</div>
                    <div style="text-align:center; font-size:1rem; color:#666; margin-bottom:15px;">* ç¹³å…¬è²»ï¼šä¸ç®—èŠ±è²»ï¼Œç®—å€‹äººä»˜å‡º<br>* å…¬è²»æ”¯å‡ºï¼šç®—èŠ±è²»ï¼Œä¸ç®—å€‹äººä»˜å‡º</div>
                    <div id="split-result-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. å·¥å…·é  -->
    <div id="p-tools" class="page">
        <div class="page-content">
            <h2 style="text-align:center; color:var(--primary);">ğŸ§° æ—…éŠå·¥å…·ç®±</h2>
            <div class="rate-calc-box">
                <div><input type="number" id="calc-in-tool" class="rate-input" placeholder="æ—¥å¹£" oninput="window.updateCalc('tool')"> JPY</div>
                <div style="font-weight:bold;">=</div>
                <div><span id="calc-res-tool" class="rate-result">0</span> TWD</div>
            </div>
            <div style="text-align:right; font-size:0.9rem; color:#888; margin-bottom:20px; padding-right:15px;">
                åŒ¯ç‡: <span id="rate-display-tool">0.22</span> <span class="rate-setting" onclick="window.setRate()">[ä¿®æ”¹]</span>
            </div>

            <div class="tools-grid">
                <div class="tool-card" onclick="window.openSubPage('check')"><div class="tool-icon">ğŸ§³</div><div class="tool-name">è¡Œææ¸…å–®</div></div>
                <div class="tool-card" onclick="window.openSubPage('foodlist')"><div class="tool-icon" style="color:#E65100;">ğŸœ</div><div class="tool-name">ç¾é£Ÿå£è¢‹</div></div>
                <div class="tool-card" onclick="window.openSubPage('wish')"><div class="tool-icon">ğŸ</div><div class="tool-name">å¿…è²·æ¸…å–®</div></div>
                <div class="tool-card" onclick="window.openSubPage('coupon')"><div class="tool-icon">ğŸ”–</div><div class="tool-name">å„ªæƒ åˆ¸å¤¾</div></div>
            </div>
        </div>
    </div>

    <!-- 4. è³‡è¨Šé  -->
    <div id="p-info" class="page">
        <div class="page-content">
            <div class="info-card">
                <h3>âœˆï¸ èˆªç­è³‡è¨Š</h3>
                <div><b>å»ç¨‹ (IT240)</b>: 1/13 06:45 TPE â” 10:00 FUK</div>
                <div style="margin-top:10px;"><b>å›ç¨‹ (IT241)</b>: 1/17 10:55 FUK â” 12:40 TPE</div>
            </div>
            <div class="info-card">
                <h3>ğŸ¨ ä½å®¿è³‡è¨Š</h3>
                <div><b>Day 1: ç”±å¸ƒé™¢å±±æ°´é¤¨</b></div>
                <div><a href="https://maps.app.goo.gl/3" target="_blank" style="color:#2196F3; font-weight:bold;">ğŸ“ é–‹å•Ÿåœ°åœ–</a></div>
                <hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">
                <div><b>Day 2-4: ä¸‰äº•èŠ±åœ’é£¯åº—ç¦å²¡ä¸­æ´²</b></div>
                <div><a href="https://maps.app.goo.gl/3" target="_blank" style="color:#2196F3; font-weight:bold;">ğŸ“ é–‹å•Ÿåœ°åœ–</a></div>
            </div>
            <div class="info-card" style="border-left:5px solid #ff7675; background:#fff5f5;">
                <h3 style="color:#d63031;">ğŸ†˜ ç·Šæ€¥è¯çµ¡</h3>
                <div style="color:#d63031; font-weight:800; font-size:1.6rem;">080-1004-0243</div>
            </div>
            <div style="text-align:center; margin-top:30px;">
                <button onclick="window.resetData()" style="background:#b2bec3; color:white; border:none; padding:12px 20px; border-radius:25px; font-size:1rem;">âš ï¸ é‡ç½®è¡Œç¨‹</button>
            </div>
        </div>
    </div>

    <!-- å°èˆª -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="window.switchPage('schedule', this)"><span class="nav-icon">ğŸ“…</span><span class="nav-label">è¡Œç¨‹</span></div>
        <div class="nav-item" onclick="window.switchPage('money', this)"><span class="nav-icon">ğŸ’´</span><span class="nav-label">è¨˜å¸³</span></div>
        <div class="nav-item" onclick="window.switchPage('tools', this)"><span class="nav-icon">ğŸ§°</span><span class="nav-label">å·¥å…·</span></div>
        <div class="nav-item" onclick="window.switchPage('info', this)"><span class="nav-icon">â„¹ï¸</span><span class="nav-label">è³‡è¨Š</span></div>
    </div>
</div>

<!-- å­é é¢å®¹å™¨ -->
<div id="sub-page-container" class="sub-page">
    <div class="sub-header">
        <button class="back-btn" onclick="window.closeSubPage()">â¬…</button>
        <h2 id="sub-title" style="margin:0; font-size:1.4rem;">æ¨™é¡Œ</h2>
    </div>
    <div id="sub-content" class="sub-content"></div>
</div>

<!-- Modal -->
<div id="modal">
    <div class="modal-box">
        <div class="modal-header" id="modal-title">ç·¨è¼¯è¡Œç¨‹</div>
        <input type="hidden" id="edit-id">
        <label>æ—¥æœŸ</label>
        <select id="edit-day"><option value="Day 1">Day 1 (1/13)</option><option value="Day 2">Day 2 (1/14)</option><option value="Day 3">Day 3 (1/15)</option><option value="Day 4">Day 4 (1/16)</option><option value="Day 5">Day 5 (1/17)</option></select>
        <label>æ™‚é–“</label><input type="time" id="edit-time">
        <label>åˆ†é¡</label>
        <select id="edit-type"><option value="spot">æ™¯é» (ç¶ )</option><option value="food">ç¾é£Ÿ (æ©˜)</option><option value="trans">äº¤é€š (è—)</option></select>
        <label>æ¨™é¡Œ</label><input type="text" id="edit-title">
        <label>è©³ç´°èªªæ˜</label>
        <textarea id="edit-desc" rows="5" placeholder="å°éŠå°æ’‡æ­¥ï¼šè¼¸å…¥ã€Œå¿…åƒã€å¿…è²·ã€é ç´„ã€æœƒè‡ªå‹•äº®é¡¯å–”ï¼"></textarea>
        <label>åœ–ç‰‡é€£çµ (é¸å¡«)</label><input type="text" id="edit-img" placeholder="https://...">
        <label>ç›¸é—œé€£çµ (é¸å¡«)</label><input type="text" id="edit-link" placeholder="https://...">
        <label>Google Map åœ°é»</label><input type="text" id="edit-loc">
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="window.saveSchedule()" class="btn-primary" style="flex:1;">å„²å­˜</button>
            <button onclick="window.closeModal()" style="flex:1; background:#dfe6e9; color:#636E72; border:none; border-radius:30px; font-weight:bold;">å–æ¶ˆ</button>
        </div>
        <button id="btn-del-sch" onclick="window.deleteSchedule()" style="width:100%; background:white; border:2px solid #ff7675; color:#ff7675; padding:10px; margin-top:15px; border-radius:30px; font-weight:bold;">åˆªé™¤æ­¤è¡Œç¨‹</button>
    </div>
</div>

<!-- Tool Input Modal -->
<div id="modal-tool">
    <div class="modal-box">
        <h3>â• æ–°å¢é …ç›®</h3>
        <input type="text" id="tool-name" placeholder="åç¨± (å¿…å¡«)">
        <textarea id="tool-note" rows="3" placeholder="å‚™è¨» / å¿…åƒé¤é» (é¸å¡«)"></textarea>
        <input type="text" id="tool-link" placeholder="ç›¸é—œé€£çµ (é¸å¡«)">
        <input type="text" id="tool-loc" placeholder="Google Map åœ°é» (é¸å¡«, ç¾é£Ÿå°ˆç”¨)">
        <label class="btn-outline">ğŸ“· é¸å–ç…§ç‰‡ <input type="file" id="tool-file" accept="image/*" style="display:none;"></label>
        <div id="tool-loading" style="display:none; text-align:center; color:#888;">æ­£åœ¨å£“ç¸®ä¸¦ä¸Šå‚³...</div>
        <button onclick="window.saveToolItem()" class="btn-primary">ä¸Šå‚³</button>
        <button onclick="document.getElementById('modal-tool').style.display='none'" style="width:100%; color:#888; border:none; background:none; margin-top:10px;">å–æ¶ˆ</button>
    </div>
</div>

<!-- Lightbox -->
<div id="modal-lightbox" onclick="this.style.display='none'">
    <img id="lightbox-img" style="max-width:90%; max-height:80vh; border-radius:8px;">
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, getDocs, writeBatch, setDoc, getDoc } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // â†“â†“â†“ è«‹å¡«å…¥æ‚¨çš„ Firebase Config â†“â†“â†“
const firebaseConfig = {
  apiKey: "AIzaSyDZzgq0W4xdHIhf6H1xC_dEScEHmAnXtiE",
  authDomain: "fukuokagina2026.firebaseapp.com",
  projectId: "fukuokagina2026",
  storageBucket: "fukuokagina2026.firebasestorage.app",
  messagingSenderId: "762021519656",
  appId: "1:762021519656:web:15c443c2ca2f13f9bc701d"
};
    // â†‘â†‘â†‘ Config çµæŸ â†‘â†‘â†‘

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    let RATE = parseFloat(localStorage.getItem('fukuoka_rate')) || 0.22;
    const PEOPLE_COUNT = 3;

    window.openTranslate = () => { window.location.href = "googletranslate://"; setTimeout(() => { window.open("https://translate.google.com/?sl=ja&tl=zh-TW", "_blank"); }, 500); };

    // --- 0. å€’æ•¸è¨ˆæ™‚ ---
    function updateCountdown() {
        const today = new Date();
        const start = new Date(2026, 0, 13);
        const end = new Date(2026, 0, 17, 23, 59, 59);
        let msg = "";
        const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        if (todayDate < start) {
            const diff = Math.ceil((start - todayDate) / (1000 * 60 * 60 * 24));
            msg = `â³ è·é›¢ç¦å²¡ä¹‹æ—…é‚„æœ‰ ${diff} å¤©ï¼`;
        } else if (todayDate >= start && today <= end) {
            const diff = Math.ceil((todayDate - start) / (1000 * 60 * 60 * 24)) + 1;
            msg = `ğŸš€ ç¦å²¡ä¹‹æ—… Day ${diff}ï¼ç©å¾—é–‹å¿ƒï¼`;
        } else {
            msg = "ğŸ  æ—…ç¨‹åœ“æ»¿çµæŸï¼Œæ­¡è¿å›å®¶ï¼";
        }
        document.getElementById("countdown-bar").innerText = msg;
    }
    updateCountdown();

    window.updateCalc = (type) => {
        const inp = document.getElementById(`calc-in-${type}`).value;
        document.getElementById(`calc-res-${type}`).innerText = Math.round(inp * RATE);
    };

    window.setRate = () => {
        const newRate = prompt("è«‹è¼¸å…¥æ–°åŒ¯ç‡ (ä¾‹å¦‚ 0.215):", RATE);
        if (newRate && !isNaN(newRate)) {
            RATE = parseFloat(newRate);
            localStorage.setItem('fukuoka_rate', RATE);
            document.getElementById("rate-display-money").innerText = RATE;
            document.getElementById("rate-display-tool").innerText = RATE;
            alert("åŒ¯ç‡å·²æ›´æ–°ï¼");
        }
    };
    document.getElementById("rate-display-money").innerText = RATE;
    document.getElementById("rate-display-tool").innerText = RATE;

    // --- 1. é¦–é è¼ªæ’­ ---
    const qBan = query(collection(db, "banners"), orderBy("timestamp", "desc"));
    onSnapshot(qBan, (snapshot) => {
        const track = document.getElementById("carousel-track");
        if(snapshot.empty) return;
        let html = "";
        snapshot.forEach(doc => {
            const d = doc.data();
            html += `<div class="carousel-slide"><img src="${d.img}" class="carousel-img"><button class="carousel-del" onclick="window.delBanner('${doc.id}')">âœ•</button></div>`;
        });
        track.innerHTML = html;
    });

    window.uploadBanner = async (input) => {
        if(input.files[0]) {
            if(!confirm("ç¢ºå®šä¸Šå‚³é€™å¼µç•¶å°é¢ï¼Ÿ")) return;
            const file = input.files[0];
            const sRef = ref(storage, 'banners/'+Date.now()+'_'+file.name);
            await uploadBytes(sRef, file);
            const imgUrl = await getDownloadURL(sRef);
            await addDoc(collection(db, "banners"), { img: imgUrl, timestamp: new Date() });
            alert("ä¸Šå‚³æˆåŠŸï¼");
        }
    };
    window.delBanner = async (id) => { if(confirm("åˆªé™¤é€™å¼µå°é¢ï¼Ÿ")) await deleteDoc(doc(db, "banners", id)); };

    // --- 2. è¡Œç¨‹é‚è¼¯ ---
    // â˜…â˜…â˜… è¨˜æ†¶åŠŸèƒ½è®Šæ•¸ â˜…â˜…â˜…
    let currentSelectedDay = "Day 1";
    
    const qSch = query(collection(db, "schedule"), orderBy("day"), orderBy("time"));
    onSnapshot(qSch, (snapshot) => {
        const container = document.getElementById("schedule-container");
        
        // â˜…â˜…â˜… è¨˜éŒ„ç•¶å‰æ²å‹•ä½ç½® â˜…â˜…â˜…
        const scrollPos = window.scrollY;

        let html="", currentDay="";
        if(snapshot.empty) { container.innerHTML="<div style='text-align:center; padding:20px; color:#999;'>å°šç„¡è¡Œç¨‹</div>"; return; }
        snapshot.forEach((doc) => {
            const d = doc.data();
            if(d.day !== currentDay) { currentDay=d.day; html+=`<div class="day-divider" data-day="${d.day}">${d.day}</div>`; }
            
            let desc = (d.desc||"").replace(/(å¿…åƒ.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-food">$1</span>')
                                  .replace(/(å¿…è²·.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-buy">$1</span>')
                                  .replace(/(é ç´„.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-res">$1</span>');

            html += `<div class="card ${d.type}" data-day="${d.day}" onclick="window.cardClick('${doc.id}', '${d.day}', '${d.time}', '${d.type}', '${d.title}', \`${d.desc||''}\`, '${d.img||''}', '${d.loc||''}', '${d.link||''}')">
                <div class="card-header"><span class="time-badge">${d.time}</span></div>
                <div class="card-title">${d.title}</div>
                <div class="card-desc">${desc}</div>
                ${d.img ? `<img src="${d.img}" class="card-img">` : ''}
                <div class="btn-group">
                    <a href="https://www.google.com/maps/search/?api=1&query=${d.loc}+ç¦å²¡" target="_blank" onclick="event.stopPropagation()" class="action-btn btn-map">ğŸ“ å°èˆª</a>
                    ${d.link ? `<a href="${d.link}" target="_blank" onclick="event.stopPropagation()" class="action-btn btn-link">ğŸ”— æ”»ç•¥</a>` : ''}
                </div>
            </div>`;
        });
        container.innerHTML = html;
        
        // â˜…â˜…â˜… æ¢å¾©åˆ°åŸæœ¬é¸æ“‡çš„å¤©æ•¸ â˜…â˜…â˜…
        const btn = Array.from(document.querySelectorAll('.day-btn')).find(b => b.innerText.includes(currentSelectedDay));
        window.filterDay(currentSelectedDay, btn);
        
        // â˜…â˜…â˜… æ¢å¾©æ²å‹•ä½ç½® (é¿å…è·³å‹•) â˜…â˜…â˜…
        if(scrollPos > 0) window.scrollTo(0, scrollPos);
    });

    let isLocked = true;
    window.toggleLock = () => { isLocked=!isLocked; const b=document.getElementById("btn-lock"); const a=document.getElementById("add-fab"); if(isLocked){b.innerHTML="ğŸ”’";b.className="fab-btn";a.style.display="none"; document.querySelectorAll(".card").forEach(c=>c.classList.remove("editable"));}else{b.innerHTML="ğŸ”“";b.className="fab-btn unlocked";a.style.display="flex"; document.querySelectorAll(".card").forEach(c=>c.classList.add("editable"));} };
    window.cardClick = (id,day,time,type,title,desc,img,loc,link) => { if(!isLocked) window.openEditModal(id,day,time,type,title,desc,img,loc,link); };
    
    // â˜…â˜…â˜… å„ªåŒ–ç¯©é¸èˆ‡è¨˜æ†¶ â˜…â˜…â˜…
    window.filterDay = (dayStr, btn) => {
        currentSelectedDay = dayStr; // è¨˜ä½é¸æ“‡
        document.querySelectorAll('.day-btn').forEach(b => b.classList.remove('active'));
        if(btn) btn.classList.add('active');
        document.querySelectorAll('.card, .day-divider').forEach(el => { if(el.dataset.day && el.dataset.day.includes(dayStr)) el.style.display='block'; else el.style.display='none'; }); window.updateWeather(dayStr); 
    };

    // --- 3. è¨˜å¸³é‚è¼¯ ---
    let allExpenses = [];
    const prepaidList = [ {name:"æ©Ÿç¥¨", amt:41490}, {name:"Klook", amt:4239}, {name:"JR", amt:3862}, {name:"ä¾¿ç•¶", amt:1260} ];
    let prepaidTotal = 0;
    function initPrepaid() { let h="", t=0; prepaidList.forEach(p=>{t+=p.amt; h+=`<div class="prepaid-list-item"><span>${p.name}</span><b>$${p.amt.toLocaleString()}</b></div>`}); document.getElementById("prepaid-list").innerHTML=h; prepaidTotal=t; }
    initPrepaid();

    const qExp = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
    onSnapshot(qExp, (snapshot) => {
        const list = document.getElementById("expense-list");
        const dashList = document.getElementById("split-result-list");
        let tripTotalCost = 0; let html = "";
        let splitMap = { "æˆ‘":0, "èŠ¬":0, "ç":0 }; 
        allExpenses = [];

        snapshot.forEach((doc) => {
            const d = doc.data();
            let amt = Number(d.amount)||0; let curr = d.currency||"TWD";
            let payer = d.payer||"æˆ‘"; let cat = d.category||"å…¶ä»–";
            let twd = curr==="JPY" ? Math.round(amt*RATE) : amt;
            
            allExpenses.push({date: new Date(d.timestamp.seconds*1000).toLocaleDateString(), item:d.item, cat:cat, payer:payer, amt:amt, curr:curr, twd:twd});

            if (cat === "ç¹³å…¬è²»") { if (payer !== "å…¬è²»") splitMap[payer] = (splitMap[payer]||0) + twd; }
            else if (payer === "å…¬è²»") { tripTotalCost += twd; }
            else { tripTotalCost += twd; splitMap[payer] = (splitMap[payer]||0) + twd; }

            let badgeClass = payer === "å…¬è²»" ? "exp-public-badge" : "exp-payer-badge";
            html += `<div class="expense-item"><div><div style="font-weight:700; color:#2D3436; font-size:1.15rem;">${d.item||"æœªå‘½å"}</div><div style="font-size:0.95rem; color:#636E72; margin-top:3px;"><span class="exp-tag ${payer==='å…¬è²»'?'public':''}">${cat}</span> <span>ğŸ‘¤ ${payer}</span></div>${d.img?`<a href="${d.img}" target="_blank" style="font-size:0.9rem; color:#2196F3; display:block; margin-top:5px; font-weight:500;">ğŸ“„ æŸ¥çœ‹æ”¶æ“š</a>`:''}</div><div style="text-align:right;"><div style="color:#e17055; font-weight:800; font-size:1.2rem;">$${twd.toLocaleString()}</div>${curr==='JPY'?`<div style="font-size:0.9rem; color:#b2bec3;">Â¥${amt.toLocaleString()}</div>`:''}<button onclick="window.delExp('${doc.id}')" style="color:#d63031; border:none; background:none; font-size:0.9rem; margin-top:5px; cursor:pointer;">åˆªé™¤</button></div></div>`;
        });
        
        list.innerHTML = html;
        document.getElementById("total-display").innerText = "NT$ " + (prepaidTotal + tripTotalCost).toLocaleString();
        
        let avg = Math.round(tripTotalCost / PEOPLE_COUNT);
        let splitHtml = `<div style="text-align:center; margin-bottom:15px; font-weight:bold; color:#2D3436; background:white; padding:10px; border-radius:10px;">ç¸½æ”¯å‡º: $${tripTotalCost.toLocaleString()} <br> å¹³å‡æ¯äºº: $${avg.toLocaleString()}</div>`;
        ["æˆ‘", "èŠ¬", "ç"].forEach(p => {
            let paid = splitMap[p] || 0; let balance = paid - avg;
            let color = balance >= 0 ? "split-get" : "split-owe";
            let text = balance >= 0 ? `+${balance.toLocaleString()} (æ”¶å›)` : `${balance.toLocaleString()} (éœ€ä»˜)`;
            splitHtml += `<div class="split-row"><span>ğŸ‘¤ ${p}</span><span>å·²ä»˜ $${paid.toLocaleString()} â” <span class="${color}">${text}</span></span></div>`;
        });
        dashList.innerHTML = splitHtml;
    });

    window.exportExcel = () => {
        let csvContent = "\uFEFFæ—¥æœŸ,é …ç›®,é¡åˆ¥,ä»˜æ¬¾äºº,åŸå¹£é‡‘é¡,å¹£åˆ¥,å°å¹£é‡‘é¡\n";
        allExpenses.forEach(e => { csvContent += `${e.date},${e.item},${e.cat},${e.payer},${e.amt},${e.curr},${e.twd}\n`; });
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "ç¦å²¡è¨˜å¸³.csv"; link.click();
    };

    window.toggleSplit = () => { const el = document.getElementById("split-section"); el.style.display = el.style.display === "block" ? "none" : "block"; if(el.style.display==="block") el.scrollIntoView({behavior:'smooth'}); };

    document.getElementById("btn-save-exp").addEventListener("click", async () => {
        const name = document.getElementById("exp-name").value; const amt = parseFloat(document.getElementById("exp-amt").value); const file = document.getElementById("exp-img-file").files[0];
        const payer = document.getElementById("exp-payer").value;
        if(!name || !amt) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
        let imgUrl = "";
        if(file) { const sRef = ref(storage, 'receipts/'+Date.now()+'_'+file.name); await uploadBytes(sRef, file); imgUrl = await getDownloadURL(sRef); }
        await addDoc(collection(db, "expenses"), { item: name, category: document.getElementById("exp-cat").value, payment: document.getElementById("exp-pay").value, currency: document.getElementById("exp-curr").value, amount: amt, payer: payer, img: imgUrl, timestamp: new Date() });
        document.getElementById("exp-name").value=""; document.getElementById("exp-amt").value=""; document.getElementById("img-preview").style.display="none"; alert("è¨˜å¸³æˆåŠŸ");
    });

    // --- 3. å·¥å…·é é‚è¼¯ ---
    let currentTool = "";
    const checkItems = ["è­·ç…§", "æ—¥å¹£", "ä¿¡ç”¨å¡", "SIMå¡/Wifiæ©Ÿ", "å……é›»å™¨", "è¡Œå‹•é›»æº", "å¸¸å‚™è—¥", "ç‰™åˆ·ç‰™è†", "æ›æ´—è¡£ç‰©", "å¥½èµ°çš„é‹"];

    window.openSubPage = (tool) => {
        document.getElementById("sub-page-container").style.display = "flex";
        const content = document.getElementById("sub-content");
        const title = document.getElementById("sub-title");
        currentTool = tool;

        if(tool === 'check') {
            title.innerText = "ğŸ§³ è¡Œææ¸…å–®";
            let saved = JSON.parse(localStorage.getItem("checklist") || "[]");
            let html = "";
            checkItems.forEach(item => {
                let isChecked = saved.includes(item) ? "checked" : "";
                html += `<div class="checklist-item ${isChecked}" onclick="window.toggleCheck(this, '${item}')"><div class="cb-icon">âœ”</div><div class="cb-text">${item}</div></div>`;
            });
            content.innerHTML = html;
        } else if (tool === 'wish' || tool === 'coupon' || tool === 'foodlist') {
            if(tool==='wish') title.innerText = "ğŸ å¿…è²·æ¸…å–®";
            else if(tool==='coupon') title.innerText = "ğŸ”– å„ªæƒ åˆ¸";
            else title.innerText = "ğŸœ ç¾é£Ÿå£è¢‹";
            loadWishlist(tool);
        }
    };

    window.closeSubPage = () => document.getElementById("sub-page-container").style.display = "none";
    window.toggleCheck = (el, item) => {
        el.classList.toggle("checked");
        let saved = JSON.parse(localStorage.getItem("checklist") || "[]");
        if(el.classList.contains("checked")) saved.push(item); else saved = saved.filter(i => i !== item);
        localStorage.setItem("checklist", JSON.stringify(saved));
    };

    function loadWishlist(type) {
        const content = document.getElementById("sub-content");
        let btnText = "â• æ–°å¢åœ–ç‰‡";
        if(type === 'foodlist') btnText = "â• æ–°å¢ç¾é£Ÿ";
        else if(type === 'coupon') btnText = "â• æ–°å¢å„ªæƒ åˆ¸";

        content.innerHTML = `<button class="btn-primary" onclick="window.openToolModal()">${btnText}</button><div id="wish-grid" class="wish-grid"></div>`;
        const q = query(collection(db, "wishlist"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            let html = "";
            snapshot.forEach(doc => {
                const d = doc.data();
                if(d.type === type) {
                     const linkBtn = d.link ? `<a href="${d.link}" target="_blank" class="tool-link-btn" onclick="event.stopPropagation()">ğŸ”— æ”»ç•¥/å®˜ç¶²</a>` : '';
                     const mapBtn = d.loc ? `<a href="https://www.google.com/maps/search/?api=1&query=${d.loc}+ç¦å²¡" target="_blank" class="tool-map-btn" onclick="event.stopPropagation()">ğŸ“ å°èˆª</a>` : '';
                     const note = d.note ? `<div class="wish-note">${d.note}</div>` : '';
                     
                     html += `<div class="wish-item" onclick="window.openLightbox('${d.img}')"><img src="${d.img}" class="wish-img"><div class="wish-info"><div class="wish-title">${d.name}</div>${note}<div class="tool-actions">${linkBtn}${mapBtn}</div></div><button class="wish-del" onclick="event.stopPropagation(); window.delWish('${doc.id}')">âœ•</button></div>`;
                }
            });
            const grid = document.getElementById("wish-grid");
            if(grid) grid.innerHTML = html;
        });
    }

    window.openToolModal = () => document.getElementById("modal-tool").style.display = "flex";
    
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                    canvas.width = w; canvas.height = h;
                    ctx.drawImage(img, 0, 0, w, h);
                    canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', quality);
                };
            };
        });
    }

    window.saveToolItem = async () => {
        const name = document.getElementById("tool-name").value; 
        const link = document.getElementById("tool-link") ? document.getElementById("tool-link").value : "";
        const note = document.getElementById("tool-note") ? document.getElementById("tool-note").value : "";
        const loc = document.getElementById("tool-loc") ? document.getElementById("tool-loc").value : "";
        
        const file = document.getElementById("tool-file").files[0];
        if(!file) return alert("è«‹é¸åœ–ç‰‡");
        
        const btn = document.querySelector("#modal-tool .btn-primary");
        const loading = document.getElementById("tool-loading");
        btn.style.display = "none"; loading.style.display = "block";

        const compressedFile = await compressImage(file, 1200, 0.7);
        const sRef = ref(storage, 'tools/'+Date.now()+'_'+file.name); 
        await uploadBytes(sRef, compressedFile); 
        const imgUrl = await getDownloadURL(sRef);
        
        await addDoc(collection(db, "wishlist"), { 
            name: name || "ç…§ç‰‡", link: link, note: note, loc: loc,
            type: currentTool, img: imgUrl, timestamp: new Date() 
        });
        
        document.getElementById("modal-tool").style.display = "none";
        // Reset fields
        document.getElementById("tool-name").value = "";
        document.getElementById("tool-link").value = "";
        document.getElementById("tool-note").value = "";
        document.getElementById("tool-loc").value = "";
        document.getElementById("tool-file").value = "";
        btn.style.display = "block"; loading.style.display = "none";
    };
    
    window.openLightbox = (url) => { document.getElementById("lightbox-img").src = url; document.getElementById("modal-lightbox").style.display = "flex"; };
    window.delWish = async(id) => { if(confirm("åˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, "wishlist", id)); };

    // --- Helpers ---
    window.openEditModal = (id,day,time,type,title,desc,img,loc,link) => { document.getElementById("modal").style.display="flex"; document.getElementById("edit-id").value=id||""; document.getElementById("edit-day").value=day||"Day 1"; document.getElementById("edit-time").value=time||"10:00"; };
    window.saveSchedule = async () => { const id = document.getElementById("edit-id").value; const data={day: document.getElementById("edit-day").value, time: document.getElementById("edit-time").value, type: document.getElementById("edit-type").value, title: document.getElementById("edit-title").value, desc: document.getElementById("edit-desc").value, img: document.getElementById("edit-img").value, loc: document.getElementById("edit-loc").value, link: document.getElementById("edit-link").value}; if(id) await updateDoc(doc(db,"schedule",id),data); else await addDoc(collection(db,"schedule"),data); window.closeModal(); };
    window.deleteSchedule = async () => { const id=document.getElementById("edit-id").value; if(id) await deleteDoc(doc(db,"schedule",id)); window.closeModal(); };
    window.closeModal = () => document.getElementById("modal").style.display="none";
    window.delExp = async(id) => { if(confirm("åˆªé™¤?")) await deleteDoc(doc(db,"expenses",id)); };
    window.calcRate = () => { const v=document.getElementById("exp-amt").value; const c=document.getElementById("exp-curr").value; document.getElementById("rate-calc").innerText = c==="JPY" ? `ç´„å°å¹£ ${Math.round(v*RATE)}` : "å°å¹£è¨ˆåƒ¹"; };
    window.previewImage = (input) => { if(input.files[0]){ let r=new FileReader(); r.onload=e=>{document.getElementById("img-preview").src=e.target.result; document.getElementById("img-preview").style.display="block";}; r.readAsDataURL(input.files[0]); } };
    window.scrollToTop = () => window.scrollTo({top:0, behavior:'smooth'});
    window.switchPage = (id, btn) => { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById('p-'+id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); };
    window.updateWeather = (day) => { const t = document.getElementById("w-tips"), l = document.getElementById("w-loc"), tm = document.getElementById("w-temp"); if(day.includes("Day 1")) { l.innerText="ç¦å²¡å¸‚"; tm.innerText="10Â°C"; t.innerText="ğŸ§¥ å¾®æ¶¼ï¼Œå¸¶è–„å¤–å¥—"; } else if(day.includes("Day 2")) { l.innerText="ç”±å¸ƒé™¢"; tm.innerText="8Â°C"; t.innerText="â„ï¸ å±±å€å†·ï¼Œç©¿ç™¼ç†±è¡£"; } else { l.innerText="ç¦å²¡å¸‚"; tm.innerText="11Â°C"; t.innerText="â›… èˆ’é©ï¼Œæ´‹è”¥å¼ç©¿æ­"; } };
    
    // åˆå§‹åŒ–
    const initialSchedule = [{ day: "Day 1", time: "11:45", title: "å¤§å±±ç‰›é›œé‹", type: "food", loc: "åšå¤šã‚‚ã¤é‹ãŠãŠã‚„ã¾ ç¦å²¡ç©ºæ¸¯", desc: "ã€å¿…åƒã€‘åšå¤šéˆé­‚ç¾é£Ÿï¼ç‰›è…¸è»Ÿå«©ã€å‘³å™Œæ¿ƒéƒã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0101.png" }];
    window.resetData = async () => { if(!confirm("ç¢ºå®šé‡ç½®è¡Œç¨‹ï¼Ÿ")) return; const q = query(collection(db, "schedule")); const snapshot = await getDocs(q); const batch = writeBatch(db); snapshot.forEach(doc => batch.delete(doc.ref)); await batch.commit(); for(let item of initialSchedule) await addDoc(collection(db, "schedule"), item); alert("å®Œæˆï¼"); };
</script>
</body>
</html>
