<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡å­è¦ªéŠ ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF8BA7;
            --text: #4A4A4A;
            --bg: #FFF9FA;
            --white: #FFFFFF;
            --accent-food: #FF9800; 
            --accent-spot: #4CAF50; 
            --accent-trans: #2196F3;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--text);
            margin: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent;
        }
        #app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }

        /* Header */
        header {
            background: var(--primary); color: var(--white); padding: 15px; text-align: center;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: white; }

        /* å¤©æ•¸æ»¾å‹•åˆ— */
        .day-nav {
            display: flex; overflow-x: auto; white-space: nowrap; background: var(--white);
            padding: 10px; position: sticky; top: 58px; z-index: 98;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .day-btn {
            background: #f0f0f0; border: none; padding: 8px 16px; margin-right: 10px;
            border-radius: 20px; color: #666; font-size: 0.95rem; cursor: pointer;
        }
        .day-btn.active { background: var(--primary); color: white; font-weight: bold; }

        /* è¡Œç¨‹å¡ç‰‡ */
        .timeline-container { padding: 15px; }
        .day-divider { margin: 20px 0 10px 0; font-weight: bold; color: #2196F3; border-bottom: 2px dashed #ccc; padding-bottom: 5px; scroll-margin-top: 130px; }
        
        .card {
            background: var(--white); border-radius: 16px; margin-bottom: 15px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative; border-left: 6px solid #ccc;
        }
        .card.food { border-left-color: var(--accent-food); }
        .card.spot { border-left-color: var(--accent-spot); }
        .card.trans { border-left-color: var(--accent-trans); }

        .card-header { display: flex; justify-content: space-between; }
        .time-badge { background: #eee; padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; }
        .card-title { font-size: 1.2rem; font-weight: bold; margin: 8px 0; }
        .card-desc { font-size: 1rem; color: #666; line-height: 1.6; white-space: pre-line; }
        .card-img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; margin-top: 10px; display:block; }
        
        .action-bar { display: flex; gap: 10px; margin-top: 10px; }
        .btn-small { flex: 1; padding: 8px; border-radius: 8px; border: none; cursor: pointer; font-size: 0.9rem; text-align: center; text-decoration: none; }
        .btn-edit { background: #FFF3E0; color: #E65100; }
        .btn-map { background: #E8F5E9; color: #2E7D32; }

        /* ç·¨è¼¯è¦–çª— (Modal) */
        #edit-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; width: 90%; max-width: 400px; padding: 20px;
            border-radius: 15px; max-height: 80vh; overflow-y: auto;
        }
        input, textarea, select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* é é¢åˆ‡æ› */
        .page { display: none; }
        .page.active { display: block; }
        
        /* åº•éƒ¨å°èˆª */
        .nav-bar { position: fixed; bottom: 0; width: 100%; max-width: 480px; background: white; height: 70px; display: flex; border-top: 1px solid #eee; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #999; padding-top: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div style="width:30px"></div>
        <h1>ç¦å²¡å­è¦ªéŠ ğŸŒ¸</h1>
        <button class="icon-btn" onclick="window.location.href = 'googletranslate://'; setTimeout(() => { window.open('https://translate.google.com/?sl=ja&tl=zh-TW', '_blank'); }, 500);">ğŸˆšï¸</button>
    </header>

    <div id="p-schedule" class="page active">
        <div class="day-nav">
            <button class="day-btn active" onclick="scrollToDay('Day 1', this)">Day 1</button>
            <button class="day-btn" onclick="scrollToDay('Day 2', this)">Day 2</button>
            <button class="day-btn" onclick="scrollToDay('Day 3', this)">Day 3</button>
            <button class="day-btn" onclick="scrollToDay('Day 4', this)">Day 4</button>
            <button class="day-btn" onclick="scrollToDay('Day 5', this)">Day 5</button>
        </div>
        <div id="loading-msg" style="text-align:center; padding:20px; color:#888;">â˜ï¸ è³‡æ–™åŒæ­¥ä¸­...</div>
        <div id="schedule-container" class="timeline-container"></div>
    </div>

    <div id="p-money" class="page">
        <div style="padding:20px; text-align:center;">
            <h2 style="color:var(--primary);">ğŸ’° è¨˜å¸³æœ¬</h2>
            <div style="background:#FFF3E0; padding:15px; border-radius:10px; margin-bottom:20px;">
                ç¸½èŠ±è²»: <span id="total-display" style="font-size:1.5rem; color:#E65100; font-weight:bold;">è¨ˆç®—ä¸­...</span>
            </div>
            <input type="text" id="exp-name" placeholder="é …ç›®åç¨±">
            <div style="display:flex; gap:5px;">
                <input type="number" id="exp-amt" placeholder="é‡‘é¡">
                <select id="exp-curr" style="width:80px;"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
            </div>
            <button onclick="addExpense()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:8px; font-size:1rem;">è¨˜å¸³</button>
            <div id="expense-list" style="margin-top:20px; text-align:left;"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('schedule', this)"><span class="nav-icon">ğŸ“…</span>è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchPage('money', this)"><span class="nav-icon">ğŸ’´</span>è¨˜å¸³</div>
    </div>
</div>

<div id="edit-modal">
    <div class="modal-box">
        <h3>âœï¸ ç·¨è¼¯è¡Œç¨‹</h3>
        <input type="hidden" id="edit-id">
        <label>æ™‚é–“</label><input type="time" id="edit-time">
        <label>æ¨™é¡Œ</label><input type="text" id="edit-title">
        <label>è©³ç´°å…§å®¹ (å¯è‡ªè¡ŒåŠ å…¥)</label><textarea id="edit-desc" rows="5"></textarea>
        <label>åœ–ç‰‡ç¶²å€</label><input type="text" id="edit-img">
        <label>Google Map åœ°é»</label><input type="text" id="edit-loc">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="saveEdit()" style="flex:1; background:#4CAF50; color:white; border:none; padding:10px; border-radius:5px;">å„²å­˜</button>
            <button onclick="closeEdit()" style="flex:1; background:#ccc; border:none; padding:10px; border-radius:5px;">å–æ¶ˆ</button>
        </div>
        <button onclick="deleteSchedule()" style="width:100%; background:none; border:1px solid red; color:red; padding:8px; border-radius:5px; margin-top:15px;">åˆªé™¤æ­¤è¡Œç¨‹</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDocs } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // â†“â†“â†“ è«‹è²¼ä¸Šæ‚¨çš„ Firebase Config â†“â†“â†“
const firebaseConfig = {
  apiKey: "AIzaSyDZzgq0W4xdHIhf6H1xC_dEScEHmAnXtiE",
  authDomain: "fukuokagina2026.firebaseapp.com",
  projectId: "fukuokagina2026",
  storageBucket: "fukuokagina2026.firebasestorage.app",
  messagingSenderId: "762021519656",
  appId: "1:762021519656:web:15c443c2ca2f13f9bc701d"
    };
    // â†‘â†‘â†‘ End Config â†‘â†‘â†‘


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const RATE = 0.22;

    // --- å®Œæ•´è±å¯Œè¡Œç¨‹è³‡æ–™ (ç”¨æ–¼è‡ªå‹•åˆå§‹åŒ–) ---
    const fullSchedule = [
        { day: "Day 1", time: "11:45", type: "food", title: "å¿…åƒã€Œå¤§å±±ã€ç‰›é›œé‹", loc: "åšå¤šã‚‚ã¤é‹ãŠãŠã‚„ã¾ ç¦å²¡ç©ºæ¸¯", desc: "ã€åšå¤šéˆé­‚ç¾é£Ÿã€‘\nç‰›è…¸è»Ÿå«©ã€å‘³å™Œæ¿ƒéƒã€‚ä½ç½®åœ¨åœ‹å…§ç·š3Fï¼Œæ’éšŠäººå¤šå¯æ”¹åƒæ‹‰éºµè·‘é“ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0101.png" },
        { day: "Day 1", time: "13:12", type: "trans", title: "é«˜é€Ÿå·´å£«å¾€ç”±å¸ƒé™¢", loc: "ç¦å²¡æ©Ÿå ´å·´å£«ç«™", desc: "åœ‹å…§ç·š2è™Ÿç«™ç‰Œæ­ä¹˜ã€Œæ¹¯å¸ƒé™¢è™Ÿã€ã€‚\nâš ï¸ è«‹æº–å‚™å¥½é ç´„æˆªåœ–ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0102.jpg" },
        { day: "Day 1", time: "15:00", type: "spot", title: "å…¥ä½ï¼šç”±å¸ƒé™¢å±±æ°´é¤¨", loc: "ç”±å¸ƒé™¢å±±æ°´é¤¨", desc: "æ›æµ´è¡£çœ‹å±±æ™¯ï¼Œäº«å—éœ²å¤©æº«æ³‰ã€‚\n[2Fæœéœ§ä¹‹æ¹¯] 13:00~25:00", img: "https://ginalitw.github.io/fukuoka-app/images/0103.jpg" },
        { day: "Day 2", time: "10:30", type: "spot", title: "é‡‘é±—æ¹–æ•£ç­–", loc: "é‡‘é±—æ¹–", desc: "æ™¨éœ§å¤¢å¹»ç¾æ™¯ï¼Œå¿…æ‹å€’å½±ã€‚\næ­¥è¡Œç´„ 20 åˆ†é˜ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0104.jpg" },
        { day: "Day 2", time: "11:30", type: "food", title: "æ¹¯ä¹‹åªè¡—é“", loc: "æ¹¯ä¹‹åªè¡—é“", desc: "é€›ç‰¹è‰²é›œè²¨ã€SNOOPYèŒ¶å±‹ã€‚\nå¿…åƒï¼šé‡‘è³å¯æ¨‚é¤…ã€B-Speak ç”Ÿä¹³æ²ã€‚" },
        { day: "Day 2", time: "17:11", type: "trans", title: "ç”±å¸ƒé™¢ä¹‹æ£®åˆ—è»Š", loc: "ç”±å¸ƒé™¢é§…", desc: "å¤¢å¹»ç¶ è‰²ç‰¹æ€¥åˆ—è»Šã€‚\nè¨˜å¾—å»é¤è»Šè“‹ç´€å¿µç« ï¼", img: "https://ginalitw.github.io/fukuoka-app/images/0105.jpg" },
        { day: "Day 3", time: "19:30", type: "food", title: "æ™šé¤ï¼šæ°´ç‚Šé›", loc: "åšå¤šè¯å‘³é³¥", desc: "åšå¤šåç‰©ï¼Œé›æ¹¯æ¿ƒéƒå……æ»¿è† åŸè›‹ç™½ã€‚" },
        { day: "Day 4", time: "10:00", type: "food", title: "å”æˆ¶å¸‚å ´", loc: "å”æˆ¶å¸‚å ´", desc: "é€±äº”é™å®šé¦¬é—œè¡—ï¼\nåƒè‡ªåŠ©é¤ä¸€æ¨£å¤¾å£½å¸ï¼Œæ²³è±šç”Ÿé­šç‰‡å¿…è©¦ã€‚", img: "https://lh5.googleusercontent.com/p/AF1QipNqR9t5C519789370603789427497127137" },
        { day: "Day 5", time: "10:55", type: "trans", title: "å‘Šåˆ¥ç¦å²¡", loc: "ç¦å²¡æ©Ÿå ´", desc: "æ­ä¹˜è™èˆª IT241 æ„‰å¿«è¿”å°ã€‚" }
    ];

    // --- 1. è‡ªå‹•æª¢æŸ¥ä¸¦çŒå…¥è³‡æ–™ ---
    async function initDataIfNeeded() {
        const q = query(collection(db, "schedule"));
        const snapshot = await getDocs(q);
        if (snapshot.empty) {
            console.log("è³‡æ–™åº«ç‚ºç©ºï¼Œé–‹å§‹è‡ªå‹•çŒå…¥...");
            document.getElementById("loading-msg").innerText = "âš™ï¸ æ­£åœ¨ç‚ºæ‚¨å»ºç«‹åˆå§‹è¡Œç¨‹...";
            for (let item of fullSchedule) {
                await addDoc(collection(db, "schedule"), item);
            }
            window.location.reload(); // çŒå®Œé‡æ–°æ•´ç†
        }
    }
    initDataIfNeeded();

    // --- 2. é¡¯ç¤ºè¡Œç¨‹ ---
    const qSch = query(collection(db, "schedule"), orderBy("day"), orderBy("time"));
    onSnapshot(qSch, (snapshot) => {
        const container = document.getElementById("schedule-container");
        if(snapshot.empty) return;
        document.getElementById("loading-msg").style.display = "none";
        
        let html = "";
        let currentDay = "";

        snapshot.forEach((doc) => {
            const data = doc.data();
            
            if (data.day !== currentDay) {
                currentDay = data.day;
                html += `<div class="day-divider" id="${data.day.replace(' ','')}">${data.day}</div>`;
            }

            html += `
            <div class="card ${data.type}">
                <div class="card-header">
                    <span class="time-badge">${data.time}</span>
                </div>
                <div class="card-title">${data.title}</div>
                <div class="card-desc">${data.desc || ''}</div>
                ${data.img ? `<img src="${data.img}" class="card-img">` : ''}
                <div class="action-bar">
                    <a href="https://www.google.com/maps/search/?api=1&query=${data.loc}+ç¦å²¡" target="_blank" class="btn-small btn-map">ğŸ“ å°èˆª</a>
                    <button class="btn-small btn-edit" onclick="openEdit('${doc.id}', '${data.time}', '${data.title}', \`${data.desc}\`, '${data.img||''}', '${data.loc||''}')">âœï¸ ç·¨è¼¯</button>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    });

    // --- 3. ç·¨è¼¯åŠŸèƒ½ ---
    window.openEdit = (id, time, title, desc, img, loc) => {
        document.getElementById("edit-id").value = id;
        document.getElementById("edit-time").value = time;
        document.getElementById("edit-title").value = title;
        document.getElementById("edit-desc").value = desc;
        document.getElementById("edit-img").value = img;
        document.getElementById("edit-loc").value = loc;
        document.getElementById("edit-modal").style.display = "flex";
    };

    window.saveEdit = async () => {
        const id = document.getElementById("edit-id").value;
        await updateDoc(doc(db, "schedule", id), {
            time: document.getElementById("edit-time").value,
            title: document.getElementById("edit-title").value,
            desc: document.getElementById("edit-desc").value,
            img: document.getElementById("edit-img").value,
            loc: document.getElementById("edit-loc").value
        });
        document.getElementById("edit-modal").style.display = "none";
    };

    window.deleteSchedule = async () => {
        if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ")) {
            const id = document.getElementById("edit-id").value;
            await deleteDoc(doc(db, "schedule", id));
            document.getElementById("edit-modal").style.display = "none";
        }
    };
    window.closeEdit = () => document.getElementById("edit-modal").style.display = "none";

    // --- 4. è¨˜å¸³åŠŸèƒ½ ---
    // é ä»˜é …ç›®
    const prepaid = [ {name:"æ©Ÿç¥¨", amt:41490}, {name:"Klook", amt:4239}, {name:"JR", amt:3862} ];
    
    // ç›£è½è¨˜å¸³
    const qExp = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
    onSnapshot(qExp, (snapshot) => {
        const list = document.getElementById("expense-list");
        let total = 0;
        let html = "";
        
        // ç®—é ä»˜
        prepaid.forEach(p => { total+=p.amt; html+=`<div style="padding:10px; border-bottom:1px solid #eee; background:#F0F8FF;">âœ… ${p.name} <b>$${p.amt}</b></div>`; });

        // ç®—å‹•æ…‹
        snapshot.forEach((doc) => {
            const d = doc.data();
            let val = d.curr === "JPY" ? Math.round(d.amt * RATE) : d.amt;
            total += val;
            html += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <span>${d.name}</span> <span style="font-weight:bold; color:#E65100;">$${val}</span>
            </div>`;
        });
        list.innerHTML = html;
        document.getElementById("total-display").innerText = "NT$ " + total.toLocaleString();
    });

    window.addExpense = async () => {
        const name = document.getElementById("exp-name").value;
        const amt = parseFloat(document.getElementById("exp-amt").value);
        if(!name || !amt) return alert("è«‹è¼¸å…¥å®Œæ•´");
        await addDoc(collection(db, "expenses"), {
            name, amt, curr: document.getElementById("exp-curr").value, timestamp: new Date()
        });
        document.getElementById("exp-name").value = "";
        document.getElementById("exp-amt").value = "";
    };

    // Helpers
    window.scrollToDay = (id, btn) => {
        document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        const el = document.getElementById(id.replace(' ','')); if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
    };
    window.switchPage = (id, btn) => {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('p-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    };
</script>
</body>
</html>
