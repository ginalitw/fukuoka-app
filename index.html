<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç¦å²¡å¥½å¥½ç© V43 ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF8BA7;
            --bg-color: #F8F9FA;
            --white: #FFFFFF;
            --text-main: #2D3436;
            --accent-food: #FF9800; 
            --accent-spot: #4CAF50; 
            --accent-trans: #2196F3;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); color: var(--text-main);
            margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; font-size: 16px;
        }
        #app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; background: #fff; }

        /* Header */
        header {
            background: rgba(255, 139, 167, 0.95); backdrop-filter: blur(10px); color: white;
            padding: 15px 20px; text-align: center; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(255, 139, 167, 0.3); display: flex; justify-content: space-between; align-items: center;
        }
        h1 { margin: 0; font-size: 1.4rem; font-weight: 700; flex-grow: 1; text-align: center; } 
        .icon-btn { 
            background: rgba(255,255,255,0.25); border: none; width: 40px; height: 40px; border-radius: 50%; 
            font-size: 1.2rem; color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; 
            transition: background 0.2s;
        }
        .icon-btn:active { background: rgba(255,255,255,0.4); }

        /* Page */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: 0; } }

        /* FAB Group */
        .fab-group { position: fixed; bottom: 100px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 99; align-items: flex-end; }
        #add-fab { 
            background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: none; justify-content: center; align-items: center; 
            font-size: 2.2rem; cursor: pointer; border: none; transition: transform 0.2s;
        }
        #add-fab:active { transform: scale(0.95); }
        #btn-lock { 
            width: 45px; height: 45px; border-radius: 50%; background: white; border: 2px solid #ccc; 
            font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: all 0.3s;
        }
        #btn-lock.unlocked { border-color: red; color: red; background: #FFEBEE; }

        /* Schedule Styles */
        .day-nav { display: flex; overflow-x: auto; white-space: nowrap; background: white; padding: 12px 15px; position: sticky; top: 70px; z-index: 98; box-shadow: 0 4px 10px rgba(0,0,0,0.03); margin: 0 -20px 20px -20px; }
        .day-btn { background: #F1F2F6; border: none; padding: 8px 18px; margin: 0 4px; border-radius: 20px; color: #636E72; font-size: 0.95rem; cursor: pointer; transition: 0.2s; }
        .day-btn.active { background: var(--primary); color: white; font-weight: bold; transform: scale(1.05); }
        
        .weather-banner { 
            background: linear-gradient(135deg, #81D4FA, #29B6F6); border-radius: 16px; padding: 18px; 
            display: flex; align-items: center; justify-content: space-between; color: white; 
            margin-bottom: 20px; box-shadow: 0 4px 10px rgba(41, 182, 246, 0.3); 
        }
        
        .day-divider { margin: 30px 0 15px 0; font-weight: bold; color: #2196F3; border-bottom: 3px dashed #ccc; padding-bottom: 5px; font-size: 1.3rem; scroll-margin-top: 140px; }

        .card { 
            background: white; border-radius: 16px; margin-bottom: 20px; padding: 20px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); border-left: 8px solid #ccc; 
            transition: transform 0.1s; 
        }
        .card.food { border-left-color: var(--accent-food); } .card.spot { border-left-color: var(--accent-spot); } .card.trans { border-left-color: var(--accent-trans); }
        .card.editable { cursor: pointer; }
        .card.editable:active { transform: scale(0.98); background: #fff0f5; }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .card-title { font-size: 1.4rem; font-weight: 700; margin: 0 0 10px 0; color: #2D3436; line-height: 1.3; }
        .time-badge { background: #F1F2F6; padding: 5px 12px; border-radius: 8px; font-weight: 700; font-size: 1rem; color: #2D3436; }
        .card-desc { font-size: 1.1rem; color: #333; line-height: 1.8; white-space: pre-line; margin-bottom: 15px; }
        .card-img { width: 100%; height: 200px; object-fit: cover; border-radius: 12px; margin-top: 10px; display:block; background:#eee;}

        .btn-group { display: flex; gap: 15px; margin-top: 18px; }
        .action-btn { flex: 1; padding: 12px; border-radius: 12px; text-align: center; text-decoration: none; font-size: 1rem; font-weight: 700; display: block; transition: transform 0.1s; }
        .btn-map { background: #E8F5E9; color: #27ae60; border: 1px solid #C8E6C9; }
        .btn-link { background: #E3F2FD; color: #0984e3; border: 1px solid #BBDEFB; }

        /* Other Styles */
        #p-schedule { padding: 0; } 
        #schedule-content-pad { padding: 0 15px 20px 15px; }
        .carousel-container { position: relative; width: 100%; height: 240px; overflow: hidden; background: #eee; margin-bottom: 10px; }
        .carousel-track { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; width: 100%; height: 100%; -webkit-overflow-scrolling: touch; }
        .carousel-track::-webkit-scrollbar { display: none; }
        .carousel-slide { flex: 0 0 100%; width: 100%; height: 100%; scroll-snap-align: center; position: relative; }
        .carousel-img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-btn { position: absolute; bottom: 15px; right: 15px; background: rgba(0,0,0,0.6); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 5px; }
        .carousel-del { position: absolute; top: 10px; right: 10px; background: rgba(255,0,0,0.7); color: white; border: none; width: 35px; height: 35px; border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: none; }
        .carousel-slide:hover .carousel-del { display: flex; justify-content: center; align-items: center; }
        .album-link-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: white; border: 2px solid #4285F4; color: #4285F4; margin: 15px 15px; padding: 12px; border-radius: 12px; font-weight: bold; text-decoration: none; font-size: 1.1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.1s; }
        .album-link-btn:active { background: #E8F0FE; transform: scale(0.98); }
        
        /* Modal & Form */
        #modal, #modal-tool, #modal-lightbox { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 85%; max-width: 400px; padding: 0; border-radius: 20px; max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-header-bar { padding: 15px; border-bottom: 1px solid #eee; text-align: center; font-size: 1.2rem; font-weight: bold; background: #fafafa; }
        .modal-body { padding: 20px; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; background: #fafafa; display: flex; gap: 10px; flex-direction: column; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.95rem; font-weight: bold; color: var(--primary); margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 5px; border: 1px solid #dfe6e9; border-radius: 8px; font-size: 1rem; box-sizing: border-box; font-family: inherit; }
        .btn-primary { background: var(--primary); color: white; border: none; width: 100%; padding: 14px; border-radius: 30px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .btn-outline { background: white; border: 2px solid #dfe6e9; color: #636E72; width: 100%; padding: 12px; border-radius: 30px; font-size: 1rem; font-weight: bold; cursor: pointer; text-align: center; display: block;}
        
        #lightbox-img { max-width: 90%; max-height: 80vh; border-radius: 8px; }
        #countdown-bar { background: #FFF3E0; color: #E65100; text-align: center; padding: 10px; font-weight: bold; font-size: 1.1rem; border-bottom: 1px solid #FFCC80; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .rate-calc-box { background: white; border: 2px solid var(--primary); border-radius: 16px; padding: 15px; margin: 15px; display: flex; align-items: center; justify-content: space-between; gap: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .rate-input { width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-size: 1.1rem; text-align: center; }
        .rate-result { font-size: 1.2rem; font-weight: bold; color: #2D3436; }
        .rate-setting { font-size: 0.8rem; color: #888; text-decoration: underline; cursor: pointer; }
        .hl-food { background: #fff3cd; color: #856404; padding: 0 4px; border-radius: 4px; }
        .hl-buy { background: #e2e3f5; color: #383d41; padding: 0 4px; border-radius: 4px; }
        .hl-res { background: #f8d7da; color: #721c24; padding: 0 4px; border-radius: 4px; }

        /* Nav Bar */
        .nav-bar { position: fixed; bottom: 0; width: 100%; max-width: 480px; background: rgba(255,255,255,0.95); height: 80px; display: flex; border-top: 1px solid rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #B2BEC3; padding-top: 12px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-icon { font-size: 1.8rem; display: block; margin-bottom: 4px; }
        .nav-label { font-size: 0.9rem; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <button class="icon-btn" onclick="window.scrollToTop()">â¬†</button>
        <h1>ç¦å²¡å¥½å¥½ç© ğŸŒ¸</h1>
        <button class="icon-btn" onclick="window.openTranslate()">ğŸˆšï¸</button>
    </header>
    
    <div id="countdown-bar"></div>

    <!-- 1. è¡Œç¨‹é  -->
    <div id="p-schedule" class="page active">
        <div class="carousel-container">
            <div id="carousel-track" style="width:100%; height:100%;">
                <img src="https://ginalitw.github.io/fukuoka-app/images/0104.jpg" style="width:100%; height:100%; object-fit:cover;">
            </div>
            <label class="carousel-btn">ğŸ“· ä¸Šå‚³å°é¢ <input type="file" accept="image/*" style="display:none;" onchange="window.uploadBanner(this)"></label>
        </div>
        
        <a href="https://photos.app.goo.gl/ukaRg1J12MkCrYsw5" target="_blank" class="album-link-btn">
            ğŸ“‚ é–‹å•Ÿ Google å®Œæ•´ç›¸ç°¿ (å…±ç”¨)
        </a>

        <div id="schedule-content-pad">
            <div class="fab-group">
                <button id="add-fab" onclick="window.openEditModal(null)">â•</button>
                <button id="btn-lock" onclick="window.toggleLock()">ğŸ”’</button>
            </div>

            <div class="day-nav">
                <button class="day-btn active" onclick="window.filterDay('Day 1', this)">Day 1</button>
                <button class="day-btn" onclick="window.filterDay('Day 2', this)">Day 2</button>
                <button class="day-btn" onclick="window.filterDay('Day 3', this)">Day 3</button>
                <button class="day-btn" onclick="window.filterDay('Day 4', this)">Day 4</button>
                <button class="day-btn" onclick="window.filterDay('Day 5', this)">Day 5</button>
            </div>

            <div class="weather-banner">
                <div>
                    <div style="font-size:2rem; font-weight:bold;" id="w-temp">--Â°C</div>
                    <div id="w-loc" style="font-weight:500; opacity:0.9; font-size:1.1rem;">æ°£è±¡é€£ç·šä¸­...</div>
                </div>
                <div style="text-align:right;">
                    <div id="w-icon" style="font-size:3rem;">â˜ï¸</div>
                    <div style="font-size:1rem; font-weight:500;" id="w-tips">ç©¿æ­å»ºè­°</div>
                </div>
            </div>

            <div id="schedule-container" style="margin-top:20px;"></div>
        </div>
    </div>

    <!-- 2. è¨˜å¸³é  -->
    <div id="p-money" class="page">
        <!-- (è¨˜å¸³é å…§å®¹ä¿æŒ V42 ä¸è®Š) -->
        <div class="info-card" style="padding:15px; margin:15px;">
            <div style="text-align:center; color:#666;">è¨˜å¸³åŠŸèƒ½è«‹è‡³ V42 æŸ¥çœ‹å®Œæ•´å…§å®¹ (æ­¤è™•ç°¡ç•¥)</div>
        </div>
    </div>

    <!-- 3. å·¥å…·é  -->
    <div id="p-tools" class="page">
        <!-- (å·¥å…·é å…§å®¹ä¿æŒ V42 ä¸è®Š) -->
         <div style="padding:15px;">å·¥å…·ç®±</div>
    </div>

    <!-- 4. è³‡è¨Šé  -->
    <div id="p-info" class="page">
        <!-- (è³‡è¨Šé å…§å®¹ä¿æŒ V42 ä¸è®Š) -->
        <div style="padding:15px;">è³‡è¨Šé </div>
    </div>

    <!-- å°èˆª -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="window.switchPage('schedule', this)"><span class="nav-icon">ğŸ“…</span><span class="nav-label">è¡Œç¨‹</span></div>
        <div class="nav-item" onclick="window.switchPage('money', this)"><span class="nav-icon">ğŸ’´</span><span class="nav-label">è¨˜å¸³</span></div>
        <div class="nav-item" onclick="window.switchPage('tools', this)"><span class="nav-icon">ğŸ§°</span><span class="nav-label">å·¥å…·</span></div>
        <div class="nav-item" onclick="window.switchPage('info', this)"><span class="nav-icon">â„¹ï¸</span><span class="nav-label">è³‡è¨Š</span></div>
    </div>
</div>

<!-- Modal: ç·¨è¼¯è¡Œç¨‹ -->
<div id="modal">
    <div class="modal-box">
        <div class="modal-header-bar" id="modal-title">âœï¸ ç·¨è¼¯/æ–°å¢è¡Œç¨‹</div>
        <div class="modal-body">
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label class="form-label">é¸æ“‡æ—¥æœŸ</label>
                <select id="edit-day">
                    <option value="Day 1">Day 1 (1/13)</option>
                    <option value="Day 2">Day 2 (1/14)</option>
                    <option value="Day 3">Day 3 (1/15)</option>
                    <option value="Day 4">Day 4 (1/16)</option>
                    <option value="Day 5">Day 5 (1/17)</option>
                </select>
            </div>
            <div class="form-group" style="display:flex; gap:10px;">
                <div style="flex:1;"><label class="form-label">æ™‚é–“</label><input type="time" id="edit-time"></div>
                <div style="flex:1;"><label class="form-label">åˆ†é¡</label><select id="edit-type"><option value="spot">æ™¯é» (ç¶ )</option><option value="food">ç¾é£Ÿ (æ©˜)</option><option value="trans">äº¤é€š (è—)</option></select></div>
            </div>
            <div class="form-group"><label class="form-label">è¡Œç¨‹æ¨™é¡Œ</label><input type="text" id="edit-title" placeholder="ä¾‹å¦‚ï¼šå¤§å±±ç‰›é›œé‹"></div>
            <div class="form-group"><label class="form-label">è©³ç´°èªªæ˜</label><textarea id="edit-desc" rows="5" placeholder="å°éŠç­†è¨˜..."></textarea></div>
            <div class="form-group">
                <label class="form-label">åœ–ç‰‡ (ä¸Šå‚³æˆ–é€£çµ)</label>
                <label class="btn-outline" style="margin-bottom:10px;">ğŸ“· ä¸Šå‚³ç…§ç‰‡ <input type="file" id="edit-file" accept="image/*" style="display:none;"></label>
                <input type="text" id="edit-img" placeholder="æˆ–è²¼ä¸Šåœ–ç‰‡é€£çµ...">
            </div>
            <div class="form-group"><label class="form-label">ç›¸é—œé€£çµ</label><input type="text" id="edit-link" placeholder="å®˜ç¶²æˆ–æ”»ç•¥ç¶²å€"></div>
            <div class="form-group"><label class="form-label">Google Map åœ°é»</label><input type="text" id="edit-loc" placeholder="è¼¸å…¥åœ°é»åç¨±"></div>
        </div>
        <div class="modal-footer">
            <button onclick="window.saveSchedule()" class="btn-primary" style="margin:0;">å„²å­˜è®Šæ›´</button>
            <button onclick="window.closeModal()" class="btn-outline" style="margin:0;">å–æ¶ˆ</button>
            <button id="btn-del-sch" onclick="window.deleteSchedule()" style="background:none; border:none; color:red; padding:10px; font-weight:bold; cursor:pointer;">ğŸ—‘ï¸ åˆªé™¤æ­¤è¡Œç¨‹</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, getDocs, writeBatch, setDoc, getDoc } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // â†“â†“â†“ è«‹å¡«å…¥æ‚¨çš„ Firebase Config â†“â†“â†“
const firebaseConfig = {
  apiKey: "AIzaSyDZzgq0W4xdHIhf6H1xC_dEScEHmAnXtiE",
  authDomain: "fukuokagina2026.firebaseapp.com",
  projectId: "fukuokagina2026",
  storageBucket: "fukuokagina2026.firebasestorage.app",
  messagingSenderId: "762021519656",
  appId: "1:762021519656:web:15c443c2ca2f13f9bc701d"
};

    // â†‘â†‘â†‘ Config çµæŸ â†‘â†‘â†‘

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    let RATE = parseFloat(localStorage.getItem('fukuoka_rate')) || 0.22;
    const PEOPLE_COUNT = 3;

    window.openTranslate = () => { window.location.href = "googletranslate://"; setTimeout(() => { window.open("https://translate.google.com/?sl=ja&tl=zh-TW", "_blank"); }, 500); };
    window.scrollToTop = () => window.scrollTo({ top: 0, behavior: 'smooth' });

    // --- 0. å€’æ•¸è¨ˆæ™‚ ---
    function updateCountdown() {
        const today = new Date();
        const start = new Date(2026, 0, 13);
        const end = new Date(2026, 0, 17, 23, 59, 59);
        let msg = "";
        const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        
        if (todayDate < start) {
            const diff = Math.ceil((start - todayDate) / (1000 * 60 * 60 * 24));
            msg = `â³ è·é›¢ç¦å²¡ä¹‹æ—…é‚„æœ‰ ${diff} å¤©ï¼`;
        } else if (todayDate >= start && today <= end) {
            const diff = Math.ceil((todayDate - start) / (1000 * 60 * 60 * 24)) + 1;
            msg = `ğŸš€ ç¦å²¡ä¹‹æ—… Day ${diff}ï¼ç©å¾—é–‹å¿ƒï¼`;
        } else {
            msg = "ğŸ  æ—…ç¨‹åœ“æ»¿çµæŸï¼Œæ­¡è¿å›å®¶ï¼";
        }
        document.getElementById("countdown-bar").innerText = msg;
    }
    updateCountdown();

    // --- 1. é¦–é è¼ªæ’­ ---
    const qBan = query(collection(db, "banners"), orderBy("timestamp", "desc"));
    onSnapshot(qBan, (snapshot) => {
        const track = document.getElementById("carousel-track");
        if(snapshot.empty) return;
        let html = "";
        snapshot.forEach(doc => {
            const d = doc.data();
            html += `<div class="carousel-slide"><img src="${d.img}" class="carousel-img"><button class="carousel-del" onclick="window.delBanner('${doc.id}')">âœ•</button></div>`;
        });
        track.innerHTML = html;
    });

    window.uploadBanner = async (input) => {
        if(input.files[0]) {
            if(!confirm("ç¢ºå®šä¸Šå‚³é€™å¼µç•¶å°é¢ï¼Ÿ")) return;
            const file = input.files[0];
            const sRef = ref(storage, 'banners/'+Date.now()+'_'+file.name);
            await uploadBytes(sRef, file);
            const imgUrl = await getDownloadURL(sRef);
            await addDoc(collection(db, "banners"), { img: imgUrl, timestamp: new Date() });
            alert("ä¸Šå‚³æˆåŠŸï¼");
        }
    };
    window.delBanner = async (id) => { if(confirm("åˆªé™¤é€™å¼µå°é¢ï¼Ÿ")) await deleteDoc(doc(db, "banners", id)); };

    // --- 2. è¡Œç¨‹é‚è¼¯ (V43 æ°£è±¡æ›´æ–°) ---
    // å®šç¾©æ¯å¤©çš„æ°£è±¡åº§æ¨™èˆ‡æ—¥æœŸ (2026)
    const tripLocs = {
        "Day 1": { lat: 33.5902, lon: 130.4017, date: "2026-01-13", name: "ç¦å²¡å¸‚" },
        "Day 2": { lat: 33.2628, lon: 131.3575, date: "2026-01-14", name: "ç”±å¸ƒé™¢" },
        "Day 3": { lat: 33.5902, lon: 130.4017, date: "2026-01-15", name: "ç¦å²¡å¸‚" },
        "Day 4": { lat: 33.8833, lon: 130.8752, date: "2026-01-16", name: "åŒ—ä¹å·" }, 
        "Day 5": { lat: 33.5902, lon: 130.4017, date: "2026-01-17", name: "ç¦å²¡å¸‚" }
    };

    function getWeatherDesc(code) {
        if (code === 0) return { icon: "â˜€ï¸", text: "æ™´æœ—" };
        if (code >= 1 && code <= 3) return { icon: "â›…", text: "å¤šé›²" };
        if (code >= 45 && code <= 48) return { icon: "ğŸŒ«ï¸", text: "æœ‰éœ§" };
        if (code >= 51 && code <= 67) return { icon: "ğŸŒ§ï¸", text: "æœ‰é›¨" };
        if (code >= 71) return { icon: "â„ï¸", text: "é™é›ª" };
        return { icon: "ğŸŒ¤ï¸", text: "æ™´æ™‚å¤šé›²" };
    }

    let weatherCache = {};

    window.updateWeather = async (day) => {
        const t = document.getElementById("w-tips"), l = document.getElementById("w-loc"), tm = document.getElementById("w-temp"), ic = document.getElementById("w-icon");
        
        // é è¨­å€¼
        if(!day) day = "Day 1";
        const locInfo = tripLocs[day];
        if(!locInfo) return;

        // æª¢æŸ¥å¿«å–
        if(weatherCache[day]) {
            const w = weatherCache[day];
            l.innerText = w.name; tm.innerText = w.temp; ic.innerText = w.icon; t.innerText = w.advice;
            return;
        }

        l.innerText = locInfo.name + " (é€£ç·šä¸­...)";
        
        try {
            // è¨ˆç®—æ—¥æœŸå·®è·
            const tripDate = new Date(locInfo.date);
            const today = new Date();
            const diffDays = Math.ceil((tripDate - today) / (1000 * 60 * 60 * 24));

            // è¶…é 16 å¤©ç„¡æ³•é å ± (Open-Meteo é™åˆ¶)
            if (diffDays > 16) {
                 l.innerText = locInfo.name; tm.innerText = "--Â°C"; ic.innerText = "ğŸ“…"; t.innerText = "é å ±å°šæœªç™¼å¸ƒ (æ¥è¿‘æ—¥æœŸé¡¯ç¤º)";
                 return;
            }

            const url = `https://api.open-meteo.com/v1/forecast?latitude=${locInfo.lat}&longitude=${locInfo.lon}&daily=weathercode,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${locInfo.date}&end_date=${locInfo.date}`;
            
            const res = await fetch(url);
            const data = await res.json();
            
            if(data.daily && data.daily.time.length > 0) {
                const min = Math.round(data.daily.temperature_2m_min[0]);
                const max = Math.round(data.daily.temperature_2m_max[0]);
                const code = data.daily.weathercode[0];
                const w = getWeatherDesc(code);
                
                let advice = `${w.text}ã€‚`;
                if(max < 10) advice += "å¯’å†·ä¿æš–ã€‚"; else if(max < 15) advice += "å¾®æ¶¼æ´‹è”¥ç©¿æ­ã€‚";
                if(code >= 51) advice += " è¨˜å¾—å¸¶å‚˜ï¼";

                const weatherObj = { name: locInfo.name, temp: `${min}~${max}Â°C`, icon: w.icon, advice: advice };
                weatherCache[day] = weatherObj; 
                
                l.innerText = weatherObj.name; tm.innerText = weatherObj.temp; ic.innerText = weatherObj.icon; t.innerText = weatherObj.advice;
            } else {
                 throw new Error("No data");
            }
        } catch(e) {
            console.error(e); 
            // å¤±æ•—å›é€€åˆ°éœæ…‹è³‡æ–™
            if(day.includes("Day 2")) { l.innerText="ç”±å¸ƒé™¢"; tm.innerText="8Â°C"; ic.innerText="â„ï¸"; t.innerText="å±±å€å†·ï¼Œç©¿ç™¼ç†±è¡£"; } 
            else { l.innerText="ç¦å²¡å¸‚"; tm.innerText="10Â°C"; ic.innerText="â›…"; t.innerText="èˆ’é©ï¼Œæ´‹è”¥å¼ç©¿æ­"; }
        }
    };

    let scheduleMap = {};
    const qSch = query(collection(db, "schedule"), orderBy("day"), orderBy("time"));
    onSnapshot(qSch, (snapshot) => {
        const container = document.getElementById("schedule-container");
        let html="", currentDay="";
        scheduleMap = {}; // é‡ç½®

        if(snapshot.empty) { container.innerHTML="<div style='text-align:center; padding:20px; color:#999;'>å°šç„¡è¡Œç¨‹</div>"; return; }
        
        snapshot.forEach((doc) => {
            const d = doc.data();
            scheduleMap[doc.id] = d;

            if(d.day !== currentDay) { currentDay=d.day; html+=`<div class="day-divider" data-day="${d.day}">${d.day}</div>`; }
            
            let desc = (d.desc||"").replace(/(å¿…åƒ.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-food">$1</span>')
                                  .replace(/(å¿…è²·.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-buy">$1</span>')
                                  .replace(/(é ç´„.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-res">$1</span>');

            html += `<div class="card ${d.type}" data-day="${d.day}" data-id="${doc.id}" onclick="window.cardClick(this)">
                <div class="card-header"><span class="time-badge">${d.time}</span></div>
                <div class="card-title">${d.title}</div>
                <div class="card-desc">${desc}</div>
                ${d.img ? `<img src="${d.img}" class="card-img">` : ''}
                <div class="btn-group">
                    <a href="https://www.google.com/maps/search/?api=1&query=${d.loc}+ç¦å²¡" target="_blank" onclick="event.stopPropagation()" class="action-btn btn-map">ğŸ“ å°èˆª</a>
                    ${d.link ? `<a href="${d.link}" target="_blank" onclick="event.stopPropagation()" class="action-btn btn-link">ğŸ”— æ”»ç•¥</a>` : ''}
                </div>
            </div>`;
        });
        container.innerHTML = html;
        window.filterDay('Day 1', document.querySelector('.day-btn'));
    });

    let isLocked = true;
    window.toggleLock = () => { isLocked=!isLocked; const b=document.getElementById("btn-lock"); const a=document.getElementById("add-fab"); if(isLocked){b.innerHTML="ğŸ”’";b.className="fab-btn";a.style.display="none"; document.querySelectorAll(".card").forEach(c=>c.classList.remove("editable"));}else{b.innerHTML="ğŸ”“";b.className="fab-btn unlocked";a.style.display="flex"; document.querySelectorAll(".card").forEach(c=>c.classList.add("editable"));} };
    window.cardClick = (el) => { if(!isLocked) { const id = el.getAttribute('data-id'); window.openEditModal(id); } };
    
    // â˜… V43 ä¿®æ”¹ï¼šåˆ‡æ›å¤©æ•¸æ™‚è§¸ç™¼å¤©æ°£æ›´æ–° â˜…
    window.filterDay = (dayStr, btn) => { 
        document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active')); 
        if(btn) btn.classList.add('active'); 
        document.querySelectorAll('.card, .day-divider').forEach(el => { 
            if(el.dataset.day && el.dataset.day.includes(dayStr)) el.style.display='block'; else el.style.display='none'; 
        }); 
        window.updateWeather(dayStr); 
    };

    // --- Helpers (åœ–ç‰‡å£“ç¸® & ç·¨è¼¯è¦–çª—) ---
    function compressImage(file, maxWidth, quality) {
        return new Promise((resolve) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    let w = img.width, h = img.height; if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                    canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
                    canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', quality);
                };
            };
        });
    }

    window.openEditModal = (id) => {
        document.getElementById("modal").style.display="flex";
        if(id) {
            const data = scheduleMap[id] || {}; 
            const titleEl = document.getElementById("modal-title"); if(titleEl) titleEl.innerText="âœï¸ ç·¨è¼¯è¡Œç¨‹";
            document.getElementById("edit-id").value = id; document.getElementById("edit-day").value = data.day;
            document.getElementById("edit-time").value = data.time; document.getElementById("edit-type").value = data.type;
            document.getElementById("edit-title").value = data.title; document.getElementById("edit-desc").value = data.desc || "";
            document.getElementById("edit-img").value = data.img || ""; document.getElementById("edit-loc").value = data.loc || "";
            document.getElementById("edit-link").value = data.link || "";
            document.getElementById("btn-del-sch").style.display="block";
        } else {
            const titleEl = document.getElementById("modal-title"); if(titleEl) titleEl.innerText="â• æ–°å¢è¡Œç¨‹";
            document.getElementById("edit-id").value=""; document.getElementById("edit-time").value="10:00";
            document.getElementById("edit-title").value=""; document.getElementById("edit-desc").value="";
            document.getElementById("edit-img").value=""; document.getElementById("edit-loc").value="";
            document.getElementById("edit-link").value=""; document.getElementById("btn-del-sch").style.display="none";
        }
    };

    window.saveSchedule = async () => {
        const id = document.getElementById("edit-id").value;
        const file = document.getElementById("edit-file").files[0];
        let imgUrl = document.getElementById("edit-img").value;
        if(file) {
            const btn = document.querySelector("#modal .btn-primary"); btn.innerText = "ä¸Šå‚³ä¸­..."; btn.disabled = true;
            const compressed = await compressImage(file, 800, 0.7);
            const sRef = ref(storage, 'schedule/'+Date.now()+'_'+file.name); await uploadBytes(sRef, compressed); imgUrl = await getDownloadURL(sRef);
            btn.innerText = "å„²å­˜"; btn.disabled = false;
        }
        const data = { day: document.getElementById("edit-day").value, time: document.getElementById("edit-time").value, type: document.getElementById("edit-type").value, title: document.getElementById("edit-title").value, desc: document.getElementById("edit-desc").value, img: imgUrl, loc: document.getElementById("edit-loc").value, link: document.getElementById("edit-link").value };
        if(id) await updateDoc(doc(db,"schedule",id), data); else await addDoc(collection(db,"schedule"), data);
        window.closeModal();
    };

    window.deleteSchedule = async () => { const id=document.getElementById("edit-id").value; if(id) await deleteDoc(doc(db,"schedule",id)); window.closeModal(); };
    window.closeModal = () => document.getElementById("modal").style.display="none";
    window.switchPage = (id, btn) => { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById('p-'+id).classList.add('active'); document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); };
</script>
</body>
</html>
