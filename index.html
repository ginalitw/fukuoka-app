<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡å­è¦ªéŠ ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF8BA7;
            --text: #4A4A4A;
            --bg: #FFF9FA;
            --white: #FFFFFF;
            --accent-food: #FF9800; 
            --accent-spot: #4CAF50; 
            --accent-trans: #2196F3;
            --font-scale: 1;
        }
        body {
            font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--text);
            margin: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent;
            font-size: calc(16px * var(--font-scale));
        }
        #app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }

        /* Header */
        header {
            background: var(--primary); color: var(--white); padding: 15px; text-align: center;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: white; }

        /* å­—é«”æ”¾å¤§ & æ–°å¢æŒ‰éˆ• */
        #font-toggle {
            position: fixed; bottom: 100px; right: 20px;
            background: var(--white); color: var(--text);
            width: 45px; height: 45px; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem; z-index: 99; cursor: pointer; border: 2px solid var(--primary);
        }
        #add-fab {
            position: fixed; bottom: 160px; right: 20px;
            background: var(--primary); color: white;
            width: 50px; height: 50px; border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            font-size: 2rem; z-index: 99; cursor: pointer; border: none;
        }

        /* é é¢åˆ‡æ› */
        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }

        /* --- è¡Œç¨‹é æ¨£å¼ --- */
        .day-nav {
            display: flex; overflow-x: auto; white-space: nowrap; background: var(--white);
            padding: 10px; position: sticky; top: 58px; z-index: 98;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin: 0 -15px 15px -15px;
        }
        .day-btn {
            background: #f0f0f0; border: none; padding: 8px 16px; margin: 0 5px;
            border-radius: 20px; color: #666; font-size: 0.95rem; cursor: pointer;
        }
        .day-btn.active { background: var(--primary); color: white; font-weight: bold; }

        .weather-banner {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border-radius: 15px; padding: 15px;
            display: flex; align-items: center; justify-content: space-between;
            color: #1565C0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px;
        }

        .day-divider { margin: 20px 0 10px 0; font-weight: bold; color: #2196F3; border-bottom: 2px dashed #ccc; padding-bottom: 5px; scroll-margin-top: 130px; }

        .card {
            background: var(--white); border-radius: 16px; margin-bottom: 15px; padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 6px solid #ccc; cursor: pointer;
        }
        .card:active { transform: scale(0.98); background: #fff0f5; }
        .card.food { border-left-color: var(--accent-food); }
        .card.spot { border-left-color: var(--accent-spot); }
        .card.trans { border-left-color: var(--accent-trans); }

        .card-title { font-size: 1.2rem; font-weight: bold; margin: 5px 0; }
        .time-badge { background: #eee; padding: 3px 8px; border-radius: 5px; font-weight: bold; font-size: 0.9rem; }
        .card-img { width: 100%; height: 160px; object-fit: cover; border-radius: 10px; margin-top: 10px; display:block; background:#eee;}

        /* --- è¨˜å¸³é æ¨£å¼ (V10é¢¨æ ¼) --- */
        .info-card { background: var(--white); padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .prepaid-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 8px 0; }
        
        .input-box { background: var(--white); padding: 15px; border-radius: 15px; margin-bottom: 20px; border: 2px solid var(--primary); }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem;}
        .btn-camera { background: #E0F7FA; color: #006064; border: 1px dashed #00ACC1; width: 100%; padding: 10px; border-radius: 10px; cursor: pointer; text-align: center; display: block; margin-bottom: 10px;}
        .btn-submit { background: var(--primary); color: white; border: none; width: 100%; padding: 12px; border-radius: 10px; font-size: 1.1rem; }
        .receipt-preview { max-width: 100%; max-height: 150px; display: none; margin-bottom: 10px; border-radius: 5px;}

        /* --- å½ˆè·³è¦–çª— (ç·¨è¼¯/æ–°å¢) --- */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; text-align: center; }

        /* åº•éƒ¨å°èˆª */
        .nav-bar { position: fixed; bottom: 0; width: 100%; max-width: 480px; background: white; height: 70px; display: flex; border-top: 1px solid #eee; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #999; padding-top: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div style="width:30px"></div>
        <h1>ç¦å²¡å­è¦ªéŠ ğŸŒ¸</h1>
        <button class="icon-btn" onclick="window.open('https://translate.google.com/?sl=ja&tl=zh-TW&op=translate', '_blank')">ğŸˆšï¸</button>
    </header>

    <div id="font-toggle" onclick="toggleFontSize()">A+</div>
    
    <div id="p-schedule" class="page active">
        <button id="add-fab" onclick="openEditModal(null)">+</button>

        <div class="day-nav">
            <button class="day-btn active" onclick="scrollToDay('Day 1', this)">Day 1</button>
            <button class="day-btn" onclick="scrollToDay('Day 2', this)">Day 2</button>
            <button class="day-btn" onclick="scrollToDay('Day 3', this)">Day 3</button>
            <button class="day-btn" onclick="scrollToDay('Day 4', this)">Day 4</button>
            <button class="day-btn" onclick="scrollToDay('Day 5', this)">Day 5</button>
        </div>

        <div class="weather-banner">
            <div>
                <div style="font-size:1.5rem; font-weight:bold;" id="w-temp">--Â°C</div>
                <div id="w-loc">æ°£è±¡é€£ç·šä¸­...</div>
            </div>
            <div style="text-align:right;">
                <div id="w-icon" style="font-size:2.5rem;">â˜ï¸</div>
                <div style="font-size:0.9rem;" id="w-tips">ç©¿æ­å»ºè­°</div>
            </div>
        </div>

        <div id="schedule-container" style="padding:0 15px;"></div>
    </div>

    <div id="p-money" class="page">
        <div class="info-card" style="background:#E3F2FD;">
            <h3>âœ… å·²ä»˜æ¬¾é …ç›® (è¡Œå‰å·²ä»˜)</h3>
            <div id="prepaid-list"></div>
        </div>

        <div class="info-card" style="text-align:center; border:2px solid #FFC6C7;">
            <div>ç¸½èŠ±è²» (å«é ä»˜)</div>
            <div id="total-display" style="font-size:2rem; font-weight:bold; color:#E91E63;">NT$ 0</div>
        </div>

        <div class="input-box">
            <h3>â• æ–°å¢æ¶ˆè²»</h3>
            <input type="text" id="exp-name" placeholder="å“é …åç¨± (å¦‚: æ‹‰éºµ)">
            <div style="display:flex; gap:10px;">
                <select id="exp-cat">
                    <option value="é¤é£²">é¤é£²</option>
                    <option value="äº¤é€š">äº¤é€š</option>
                    <option value="è³¼ç‰©">è³¼ç‰©</option>
                    <option value="è—¥å¦">è—¥å¦</option>
                    <option value="ä½å®¿">ä½å®¿</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <select id="exp-pay">
                    <option value="ç¾é‡‘">ç¾é‡‘</option>
                    <option value="åˆ·å¡">åˆ·å¡</option>
                    <option value="ICå¡">ICå¡</option>
                </select>
            </div>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="number" id="exp-amt" placeholder="é‡‘é¡">
                <select id="exp-curr" style="width:80px;" onchange="calcRate()"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
            </div>
            <div id="rate-calc" style="text-align:right; color:#888; font-size:0.9rem; margin-bottom:10px;">ç´„å°å¹£ 0 å…ƒ</div>
            
            <label class="btn-camera">ğŸ“· æ‹ç…§ / ä¸Šå‚³æ”¶æ“š <input type="file" id="exp-img-file" accept="image/*" style="display:none;" onchange="previewImage(this)"></label>
            <img id="img-preview" class="receipt-preview">
            
            <button class="btn-submit" id="btn-save-exp">è¨˜å¸³</button>
        </div>

        <div id="expense-list" style="padding-bottom:20px;"></div>
    </div>

    <div id="p-info" class="page">
        <div class="info-card">
            <h3>âœˆï¸ èˆªç­è³‡è¨Š</h3>
            <div><b>å»ç¨‹ (IT240)</b>: 1/13 06:45 TPE â” 10:00 FUK</div>
            <div style="margin-top:10px;"><b>å›ç¨‹ (IT241)</b>: 1/17 10:55 FUK â” 12:40 TPE</div>
        </div>
        <div class="info-card">
            <h3>ğŸ¨ ä½å®¿è³‡è¨Š</h3>
            <div><b>Day 1: ç”±å¸ƒé™¢å±±æ°´é¤¨</b></div>
            <div><a href="https://maps.app.goo.gl/YourLink" target="_blank">ğŸ“ é–‹å•Ÿåœ°åœ–</a></div>
            <hr style="border:0; border-top:1px dashed #eee; margin:10px 0;">
            <div><b>Day 2-4: ä¸‰äº•èŠ±åœ’é£¯åº—ç¦å²¡ä¸­æ´²</b></div>
            <div><a href="https://maps.app.goo.gl/YourLink" target="_blank">ğŸ“ é–‹å•Ÿåœ°åœ–</a></div>
        </div>
        <div class="info-card" style="border-left:5px solid red;">
            <h3>ğŸ†˜ ç·Šæ€¥è¯çµ¡</h3>
            <div style="color:red; font-weight:bold; font-size:1.2rem;">080-1004-0243</div>
            <div>æ—…å¤–åœ‹äººæ€¥é›£æ•‘åŠ©</div>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="resetData()" style="background:#607D8B; color:white; border:none; padding:10px; border-radius:5px;">âš ï¸ é‡ç½®æ‰€æœ‰è¡Œç¨‹ (ä¿®å¾©ç”¨)</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchPage('schedule', this)"><span class="nav-icon">ğŸ“…</span>è¡Œç¨‹</div>
        <div class="nav-item" onclick="switchPage('money', this)"><span class="nav-icon">ğŸ’´</span>è¨˜å¸³</div>
        <div class="nav-item" onclick="switchPage('info', this)"><span class="nav-icon">â„¹ï¸</span>è³‡è¨Š</div>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <div class="modal-header" id="modal-title">ç·¨è¼¯è¡Œç¨‹</div>
        <input type="hidden" id="edit-id">
        <label>æ—¥æœŸ</label>
        <select id="edit-day">
            <option value="Day 1">Day 1 (1/13)</option>
            <option value="Day 2">Day 2 (1/14)</option>
            <option value="Day 3">Day 3 (1/15)</option>
            <option value="Day 4">Day 4 (1/16)</option>
            <option value="Day 5">Day 5 (1/17)</option>
        </select>
        <label>æ™‚é–“</label><input type="time" id="edit-time">
        <label>åˆ†é¡</label>
        <select id="edit-type">
            <option value="spot">æ™¯é» (ç¶ )</option>
            <option value="food">ç¾é£Ÿ (æ©˜)</option>
            <option value="trans">äº¤é€š (è—)</option>
        </select>
        <label>æ¨™é¡Œ</label><input type="text" id="edit-title">
        <label>è©³ç´°èªªæ˜</label><textarea id="edit-desc" rows="4"></textarea>
        <label>åœ–ç‰‡é€£çµ (é¸å¡«)</label><input type="text" id="edit-img" placeholder="https://...">
        <label>Google Map åœ°é»</label><input type="text" id="edit-loc">
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="saveSchedule()" class="btn-submit" style="flex:1;">å„²å­˜</button>
            <button onclick="closeModal()" style="flex:1; background:#ccc; border:none; border-radius:8px;">å–æ¶ˆ</button>
        </div>
        <button id="btn-del-sch" onclick="deleteSchedule()" style="width:100%; background:white; border:1px solid red; color:red; padding:10px; margin-top:15px; border-radius:8px;">åˆªé™¤æ­¤è¡Œç¨‹</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, getDocs, writeBatch } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

 // â†“â†“â†“ è«‹è²¼ä¸Šæ‚¨çš„ Firebase Config â†“â†“â†“
const firebaseConfig = {
  apiKey: "AIzaSyDZzgq0W4xdHIhf6H1xC_dEScEHmAnXtiE",
  authDomain: "fukuokagina2026.firebaseapp.com",
  projectId: "fukuokagina2026",
  storageBucket: "fukuokagina2026.firebasestorage.app",
  messagingSenderId: "762021519656",
  appId: "1:762021519656:web:15c443c2ca2f13f9bc701d"
    };
    // â†‘â†‘â†‘ End Config â†‘â†‘â†‘


    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const RATE = 0.22;

    // --- 1. åˆå§‹è³‡æ–™ (æŒ‰é‡ç½®éµæœƒå¯«å…¥é€™äº›) ---
    const initialSchedule = [
        { day: "Day 1", time: "11:45", title: "å¤§å±±ç‰›é›œé‹", type: "food", loc: "åšå¤šã‚‚ã¤é‹ãŠãŠã‚„ã¾", desc: "å¿…åƒå‘³å™Œå£å‘³ï¼åœ‹å…§ç·š3Fã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0101.png" },
        { day: "Day 1", time: "13:12", title: "å·´å£«å¾€ç”±å¸ƒé™¢", type: "trans", loc: "ç¦å²¡æ©Ÿå ´å·´å£«ç«™", desc: "åœ‹å…§ç·š2è™Ÿç«™ç‰Œï¼Œæ­ä¹˜ã€Œæ¹¯å¸ƒé™¢è™Ÿã€ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0102.jpg" },
        { day: "Day 1", time: "15:00", title: "å…¥ä½å±±æ°´é¤¨", type: "spot", loc: "ç”±å¸ƒé™¢å±±æ°´é¤¨", desc: "äº«å—éœ²å¤©æº«æ³‰ï¼Œæ™šé¤åƒå’Œç‰›ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0103.jpg" },
        { day: "Day 2", time: "10:30", title: "é‡‘é±—æ¹–", type: "spot", loc: "é‡‘é±—æ¹–", desc: "æ™¨éœ§ç¾æ™¯ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0104.jpg" },
        { day: "Day 2", time: "17:11", title: "ç”±å¸ƒé™¢ä¹‹æ£®", type: "trans", loc: "ç”±å¸ƒé™¢é§…", desc: "ç‰¹æ€¥åˆ—è»Šå›åšå¤šã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0105.jpg" },
        { day: "Day 3", time: "19:30", title: "æ°´ç‚Šé›æ™šé¤", type: "food", loc: "åšå¤šè¯å‘³é³¥", desc: "åšå¤šåç‰©é›æ¹¯é‹ã€‚" },
        { day: "Day 4", time: "10:00", title: "å”æˆ¶å¸‚å ´", type: "food", loc: "å”æˆ¶å¸‚å ´", desc: "é€±äº”é™å®šé¦¬é—œè¡—å£½å¸ã€‚", img: "https://lh5.googleusercontent.com/p/AF1QipNqR9t5C519789370603789427497127137" }
    ];

    // é‡ç½®åŠŸèƒ½ (åœ¨è³‡è¨Šé )
    window.resetData = async () => {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤ç¾æœ‰è¡Œç¨‹ï¼Œé‡æ–°è¼‰å…¥é è¨­å€¼å—ï¼Ÿ")) return;
        const q = query(collection(db, "schedule"));
        const snapshot = await getDocs(q);
        const batch = writeBatch(db);
        snapshot.forEach(doc => batch.delete(doc.ref));
        await batch.commit(); // æ¸…ç©º
        
        // é‡æ–°å¯«å…¥
        for(let item of initialSchedule) {
            await addDoc(collection(db, "schedule"), item);
        }
        alert("é‡ç½®å®Œæˆï¼è«‹å›è¡Œç¨‹é æŸ¥çœ‹ã€‚");
    };

    // --- 2. è¡Œç¨‹é¡¯ç¤º & ç·¨è¼¯ ---
    const qSch = query(collection(db, "schedule"), orderBy("day"), orderBy("time"));
    onSnapshot(qSch, (snapshot) => {
        const container = document.getElementById("schedule-container");
        let html = "";
        let currentDay = "";
        
        if(snapshot.empty) {
            container.innerHTML = "<div style='text-align:center; padding:20px; color:#999;'>å°šç„¡è¡Œç¨‹ï¼Œè«‹æŒ‰ + æ–°å¢<br>æˆ–åˆ°è³‡è¨Šé æŒ‰é‡ç½®</div>";
            return;
        }

        snapshot.forEach((doc) => {
            const data = doc.data();
            if(data.day !== currentDay) {
                currentDay = data.day;
                html += `<div class="day-divider" id="${data.day.replace(' ','')}">${data.day}</div>`;
                updateWeather(data.day);
            }
            
            // é»æ“Šé–‹å•Ÿç·¨è¼¯
            const editAttr = `onclick="openEditModal('${doc.id}', '${data.day}', '${data.time}', '${data.type}', '${data.title}', \`${data.desc||''}\`, '${data.img||''}', '${data.loc||''}')"`;

            html += `
            <div class="card ${data.type}" ${editAttr}>
                <div style="display:flex; justify-content:space-between;">
                    <span class="time-badge">${data.time}</span>
                </div>
                <div class="card-title">${data.title}</div>
                <div style="font-size:0.95rem; color:#666; white-space:pre-line;">${data.desc||''}</div>
                ${data.img ? `<img src="${data.img}" class="card-img">` : ''}
                <a href="https://www.google.com/maps/search/?api=1&query=${data.loc}+ç¦å²¡" target="_blank" onclick="event.stopPropagation()" style="display:inline-block; margin-top:10px; color:#2196F3; font-weight:bold; text-decoration:none;">ğŸ“ å°èˆª</a>
            </div>`;
        });
        container.innerHTML = html;
    });

    // ç·¨è¼¯/æ–°å¢ è¦–çª—é‚è¼¯
    window.openEditModal = (id, day, time, type, title, desc, img, loc) => {
        document.getElementById("modal").style.display = "flex";
        if(id) {
            // ç·¨è¼¯æ¨¡å¼
            document.getElementById("modal-title").innerText = "âœï¸ ç·¨è¼¯è¡Œç¨‹";
            document.getElementById("edit-id").value = id;
            document.getElementById("edit-day").value = day;
            document.getElementById("edit-time").value = time;
            document.getElementById("edit-type").value = type;
            document.getElementById("edit-title").value = title;
            document.getElementById("edit-desc").value = desc;
            document.getElementById("edit-img").value = img;
            document.getElementById("edit-loc").value = loc;
            document.getElementById("btn-del-sch").style.display = "block";
        } else {
            // æ–°å¢æ¨¡å¼
            document.getElementById("modal-title").innerText = "â• æ–°å¢è¡Œç¨‹";
            document.getElementById("edit-id").value = "";
            document.getElementById("edit-time").value = "10:00";
            document.getElementById("edit-title").value = "";
            document.getElementById("edit-desc").value = "";
            document.getElementById("edit-img").value = "";
            document.getElementById("edit-loc").value = "";
            document.getElementById("btn-del-sch").style.display = "none";
        }
    };

    window.saveSchedule = async () => {
        const id = document.getElementById("edit-id").value;
        const data = {
            day: document.getElementById("edit-day").value,
            time: document.getElementById("edit-time").value,
            type: document.getElementById("edit-type").value,
            title: document.getElementById("edit-title").value,
            desc: document.getElementById("edit-desc").value,
            img: document.getElementById("edit-img").value,
            loc: document.getElementById("edit-loc").value
        };

        if(id) await updateDoc(doc(db, "schedule", id), data);
        else await addDoc(collection(db, "schedule"), data);
        
        closeModal();
    };

    window.deleteSchedule = async () => {
        const id = document.getElementById("edit-id").value;
        if(id && confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
            await deleteDoc(doc(db, "schedule", id));
            closeModal();
        }
    };
    window.closeModal = () => document.getElementById("modal").style.display = "none";

    // --- 3. è¨˜å¸³é‚è¼¯ (V10 å¾©åˆ») ---
    const prepaidList = [ {name:"æ©Ÿç¥¨", amt:41490}, {name:"Klook", amt:4239}, {name:"JR", amt:3862}, {name:"ä¾¿ç•¶", amt:1260} ];
    function renderPrepaid() {
        let html="", total=0;
        prepaidList.forEach(p => { 
            total += p.amt; 
            html += `<div class="prepaid-item"><span>${p.name}</span><b>$${p.amt.toLocaleString()}</b></div>`; 
        });
        document.getElementById("prepaid-list").innerHTML = html;
        return total;
    }

    const qExp = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
    onSnapshot(qExp, (snapshot) => {
        const list = document.getElementById("expense-list");
        let preT = renderPrepaid();
        let dynT = 0;
        let html = "";
        
        snapshot.forEach((doc) => {
            const d = doc.data();
            let twd = d.currency === "JPY" ? Math.round(d.amount * RATE) : d.amount;
            dynT += twd;
            
            html += `
            <div style="background:white; padding:10px; border-radius:10px; margin-bottom:10px; border-left:4px solid #FF9800; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-weight:bold;">${d.item}</div>
                    <div style="font-size:0.8rem; color:#888;">${d.category} Â· ${d.payment}</div>
                    ${d.img ? `<a href="${d.img}" target="_blank" style="font-size:0.8rem; color:#2196F3;">ğŸ“„ æŸ¥çœ‹æ”¶æ“š</a>` : ''}
                </div>
                <div style="text-align:right;">
                    <div style="color:#E91E63; font-weight:bold;">$${twd.toLocaleString()}</div>
                    ${d.currency==='JPY' ? `<div style="font-size:0.8rem; color:#aaa;">Â¥${d.amount}</div>` : ''}
                    <button onclick="delExp('${doc.id}')" style="color:red; border:none; background:none; font-size:0.8rem;">åˆªé™¤</button>
                </div>
            </div>`;
        });
        list.innerHTML = html;
        document.getElementById("total-display").innerText = "NT$ " + (preT + dynT).toLocaleString();
    });

    document.getElementById("btn-save-exp").addEventListener("click", async () => {
        const btn = document.getElementById("btn-save-exp");
        btn.innerText = "â³ å„²å­˜ä¸­..."; btn.disabled = true;
        try {
            const name = document.getElementById("exp-name").value;
            const amt = parseFloat(document.getElementById("exp-amt").value);
            const file = document.getElementById("exp-img-file").files[0];
            if(!name || !amt) throw new Error("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");

            let imgUrl = "";
            if(file) {
                const sRef = ref(storage, 'receipts/' + Date.now() + '_' + file.name);
                await uploadBytes(sRef, file);
                imgUrl = await getDownloadURL(sRef);
            }

            await addDoc(collection(db, "expenses"), {
                item: name, category: document.getElementById("exp-cat").value,
                payment: document.getElementById("exp-pay").value,
                currency: document.getElementById("exp-curr").value,
                amount: amt, img: imgUrl, timestamp: new Date()
            });

            document.getElementById("exp-name").value = "";
            document.getElementById("exp-amt").value = "";
            document.getElementById("img-preview").style.display="none";
            alert("è¨˜å¸³æˆåŠŸï¼");
        } catch(e) { alert(e.message); } finally { btn.innerText = "è¨˜å¸³"; btn.disabled = false; }
    });

    // Helpers
    window.previewImage = (input) => {
        if(input.files[0]){ let r = new FileReader(); r.onload=e=>{document.getElementById("img-preview").src=e.target.result; document.getElementById("img-preview").style.display="block";}; r.readAsDataURL(input.files[0]); }
    };
    window.calcRate = () => {
        const v = document.getElementById("exp-amt").value;
        const c = document.getElementById("exp-curr").value;
        document.getElementById("rate-calc").innerText = c==="JPY" ? `ç´„å°å¹£ ${Math.round(v*RATE)}` : "å°å¹£è¨ˆåƒ¹";
    };
    window.delExp = async(id) => { if(confirm("åˆªé™¤?")) await deleteDoc(doc(db,"expenses",id)); };
    window.updateWeather = (day) => {
        const t = document.getElementById("w-tips"), l = document.getElementById("w-loc"), tm = document.getElementById("w-temp");
        if(day.includes("Day 1")) { l.innerText="ç¦å²¡å¸‚"; tm.innerText="10Â°C"; t.innerText="ğŸ§¥ å¾®æ¶¼ï¼Œå¸¶è–„å¤–å¥—"; }
        else if(day.includes("Day 2")) { l.innerText="ç”±å¸ƒé™¢"; tm.innerText="8Â°C"; t.innerText="â„ï¸ å±±å€å†·ï¼Œç©¿ç™¼ç†±è¡£"; }
        else { l.innerText="ç¦å²¡å¸‚"; tm.innerText="11Â°C"; t.innerText="â›… èˆ’é©ï¼Œæ´‹è”¥å¼ç©¿æ­"; }
    };
    window.scrollToDay = (id, btn) => {
        document.querySelectorAll('.day-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        const el = document.getElementById(id.replace(' ','')); if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
        updateWeather(id);
    };
    window.switchPage = (id, btn) => {
        document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
        document.getElementById('p-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
    };
    let fs = 1; window.toggleFontSize = () => { fs = fs===1?1.3:1; document.documentElement.style.setProperty('--font-scale', fs); };
</script>
</body>
</html>
