<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¦å²¡å¥½å¥½ç© ğŸŒ¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FF8BA7; --text: #4A4A4A; --bg: #FFF9FA; --white: #FFFFFF; --accent-food: #FF9800; --accent-spot: #4CAF50; --accent-trans: #2196F3; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; font-size: 16px; }
        #app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }
        
        /* Header */
        header { background: var(--primary); color: var(--white); padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .icon-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); font-size: 1.5rem; cursor: pointer; color: white; width: 45px; height: 45px; border-radius: 50%; display: flex; justify-content: center; align-items: center; }

        /* Floating Buttons */
        .fab-group { position: fixed; bottom: 90px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 99; }
        .fab-btn { width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; }
        .fab-btn:active { transform: scale(0.9); }
        
        #btn-lock { background: white; color: #555; border: 2px solid #ccc; }
        #btn-lock.unlocked { background: #FFEBEE; color: #D32F2F; border-color: #D32F2F; }
        
        #btn-add { background: var(--primary); color: white; display: none; } /* é è¨­éš±è— */
        #btn-top { background: white; color: var(--primary); display: none; border: 2px solid var(--primary); }

        .page { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: 0; } }
        
        /* Schedule */
        .day-nav { display: flex; overflow-x: auto; white-space: nowrap; background: var(--white); padding: 10px; position: sticky; top: 68px; z-index: 98; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin: 0 -15px 15px -15px; }
        .day-btn { background: #f0f0f0; border: none; padding: 8px 16px; margin: 0 5px; border-radius: 20px; color: #666; font-size: 0.95rem; cursor: pointer; transition: 0.2s; }
        .day-btn.active { background: var(--primary); color: white; font-weight: bold; transform: scale(1.05); }
        .weather-banner { background: linear-gradient(135deg, #E3F2FD, #BBDEFB); border-radius: 15px; padding: 15px; display: flex; align-items: center; justify-content: space-between; color: #1565C0; margin-bottom: 20px; }
        .day-divider { margin: 25px 0 10px 0; font-weight: bold; color: #2196F3; border-bottom: 2px dashed #ccc; padding-bottom: 5px; font-size: 1.1rem; }

        .card { background: var(--white); border-radius: 16px; margin-bottom: 15px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 6px solid #ccc; transition: 0.2s; }
        .card.editable { cursor: pointer; } /* åªæœ‰è§£é–æ™‚è®Šæ‰‹æŒ‡ */
        .card.editable:active { transform: scale(0.98); background: #fff0f5; }
        .card.food { border-left-color: var(--accent-food); }
        .card.spot { border-left-color: var(--accent-spot); }
        .card.trans { border-left-color: var(--accent-trans); }
        .card-title { font-size: 1.25rem; font-weight: bold; margin: 8px 0; color: #333; }
        .time-badge { background: #eee; padding: 3px 8px; border-radius: 5px; font-weight: bold; font-size: 0.9rem; color: #555; }
        .card-desc { font-size: 1rem; color: #666; line-height: 1.7; white-space: pre-line; margin-top: 8px; }
        .card-img { width: 100%; height: 180px; object-fit: cover; border-radius: 10px; margin-top: 10px; display:block; background:#eee;}
        .btn-group { display: flex; gap: 10px; margin-top: 12px; }
        .action-btn { flex: 1; padding: 8px; border-radius: 8px; text-align: center; text-decoration: none; font-size: 0.9rem; font-weight: bold; display: block; }
        .btn-map { background: #E8F5E9; color: #2E7D32; }
        .btn-link { background: #E3F2FD; color: #1565C0; }

        /* Highlights */
        .hl-food { background: #FFF3E0; color: #E65100; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .hl-buy { background: #F3E5F5; color: #6A1B9A; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .hl-res { background: #FFEBEE; color: #C62828; padding: 2px 4px; border-radius: 4px; font-weight: bold; }
        .hl-star { background: #FFF9C4; color: #F57F17; padding: 2px 4px; border-radius: 4px; font-weight: bold; }

        /* Expense */
        .info-card { background: var(--white); padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .prepaid-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.95rem; color: #555; }
        
        .input-box { background: var(--white); padding: 20px 15px; border-radius: 15px; margin-bottom: 20px; border: 2px solid #FFC6C7; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1rem;}
        
        .btn-camera { background: #E0F7FA; color: #006064; border: 1px dashed #00ACC1; width: 85%; padding: 10px; border-radius: 25px; cursor: pointer; text-align: center; display: block; margin: 10px auto; font-weight: bold; }
        .btn-submit { background: var(--primary); color: white; border: none; width: 85%; padding: 12px; border-radius: 25px; font-size: 1.1rem; display: block; margin: 15px auto 0 auto; box-shadow: 0 4px 6px rgba(255, 139, 167, 0.3); }
        .receipt-preview { max-width: 100%; max-height: 150px; display: none; margin: 10px auto; border-radius: 5px;}
        
        .expense-item { background: white; padding: 12px; border-radius: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #FF9800; }
        .exp-payer-badge { background: #eee; color: #555; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; }
        .exp-public-badge { background: #E0F2F1; color: #00695C; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; }

        /* Split Bill Dashboard */
        #split-section { display: none; margin-top: 30px; animation: fadeIn 0.3s; }
        .split-dashboard { background: #FFFDE7; border: 2px solid #FFD54F; border-radius: 15px; padding: 15px; margin-bottom: 50px; }
        .split-title { text-align: center; font-weight: bold; color: #F57F17; margin-bottom: 10px; font-size: 1.1rem; }
        .split-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 1rem; border-bottom: 1px dashed #ddd; padding-bottom: 5px; }
        .split-owe { color: red; font-weight: bold; }
        .split-get { color: green; font-weight: bold; }
        .btn-toggle-split { background: #607D8B; color: white; border: none; padding: 10px 20px; border-radius: 25px; margin: 20px auto; display: block; font-size: 1rem; cursor: pointer; }

        /* Modal */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; max-height: 90vh; overflow-y: auto; }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; text-align: center; }

        /* Nav */
        .nav-bar { position: fixed; bottom: 0; width: 100%; max-width: 480px; background: white; height: 70px; display: flex; border-top: 1px solid #eee; z-index: 100; }
        .nav-item { flex: 1; text-align: center; color: #999; padding-top: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; display: block; margin-bottom: 2px; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div style="width:45px"></div>
        <h1>ç¦å²¡å¥½å¥½ç© ğŸŒ¸</h1>
        <button class="icon-btn" onclick="window.openTranslate()">ğŸˆšï¸</button>
    </header>
    
    <div id="p-schedule" class="page active">
        <div class="fab-group">
            <button id="btn-top" class="fab-btn" onclick="window.scrollToTop()">â¬†</button>
            <button id="btn-add" class="fab-btn" onclick="window.openEditModal(null)">â•</button>
            <button id="btn-lock" class="fab-btn" onclick="window.toggleLock()">ğŸ”’</button>
        </div>

        <div class="day-nav">
            <button class="day-btn active" onclick="window.filterDay('Day 1', this)">Day 1</button>
            <button class="day-btn" onclick="window.filterDay('Day 2', this)">Day 2</button>
            <button class="day-btn" onclick="window.filterDay('Day 3', this)">Day 3</button>
            <button class="day-btn" onclick="window.filterDay('Day 4', this)">Day 4</button>
            <button class="day-btn" onclick="window.filterDay('Day 5', this)">Day 5</button>
        </div>

        <div class="weather-banner">
            <div><div style="font-size:1.5rem; font-weight:bold;" id="w-temp">--Â°C</div><div id="w-loc">æ°£è±¡é€£ç·šä¸­...</div></div>
            <div style="text-align:right;"><div id="w-icon" style="font-size:2.5rem;">â˜ï¸</div><div style="font-size:0.9rem;" id="w-tips">ç©¿æ­å»ºè­°</div></div>
        </div>

        <div id="schedule-container" style="padding:0 15px;"></div>
    </div>

    <div id="p-money" class="page">
        
        <div class="info-card" style="text-align:center; border:2px solid #FFC6C7;">
            <div style="color:#666;">æ—…é€”ç¸½èŠ±è²» (å«å…¬è²»æ”¯å‡º)</div>
            <div id="total-display" style="font-size:2rem; font-weight:bold; color:#E91E63;">è¨ˆç®—ä¸­...</div>
        </div>

        <div class="input-box">
            <h3 style="margin-top:0; text-align:center;">â• æ–°å¢æ¶ˆè²»</h3>
            <div style="margin-bottom:10px; text-align:center;">
                <label style="font-weight:bold; color:#E91E63;">èª°ä»˜çš„éŒ¢ï¼Ÿ</label>
                <select id="exp-payer" style="width:auto; display:inline-block; padding:8px;">
                    <option value="æˆ‘">æˆ‘</option>
                    <option value="èŠ¬">èŠ¬</option>
                    <option value="ç">ç</option>
                    <option value="å…¬è²»">å…¬è²» (å¾å…¬æ¬¾æ‰£)</option>
                </select>
            </div>

            <input type="text" id="exp-name" placeholder="å“é …åç¨± (å¦‚: æ‹‰éºµ)">
            <div style="display:flex; gap:10px;">
                <select id="exp-cat">
                    <option value="é¤é£²">é¤é£²</option>
                    <option value="äº¤é€š">äº¤é€š</option>
                    <option value="è³¼ç‰©">è³¼ç‰©</option>
                    <option value="è—¥å¦">è—¥å¦</option>
                    <option value="ä½å®¿">ä½å®¿</option>
                    <option value="ç¹³å…¬è²»">ç¹³å…¬è²» (å­˜å…¥å…¬æ¬¾)</option>
                    <option value="å…¶ä»–">å…¶ä»–</option>
                </select>
                <select id="exp-pay"><option value="ç¾é‡‘">ç¾é‡‘</option><option value="åˆ·å¡">åˆ·å¡</option><option value="ICå¡">ICå¡</option></select>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="number" id="exp-amt" placeholder="ç¸½é‡‘é¡">
                <select id="exp-curr" style="width:80px;" onchange="window.calcRate()"><option value="JPY">JPY</option><option value="TWD">TWD</option></select>
            </div>
            <div id="rate-calc" style="text-align:right; color:#888; font-size:0.9rem; margin-bottom:10px;">ç´„å°å¹£ 0 å…ƒ</div>
            
            <label class="btn-camera">ğŸ“· æ‹ç…§ / ä¸Šå‚³æ”¶æ“š <input type="file" id="exp-img-file" accept="image/*" style="display:none;" onchange="window.previewImage(this)"></label>
            <img id="img-preview" class="receipt-preview">
            <button class="btn-submit" id="btn-save-exp">è¨˜å¸³</button>
        </div>
        
        <h3 style="padding-left:15px; margin-bottom:10px;">ğŸ“‹ æ¶ˆè²»åˆ—è¡¨</h3>
        <div id="expense-list" style="padding-bottom:20px; padding: 0 15px;"></div>
        
        <div class="info-card" style="background:#E3F2FD;">
            <h4 style="margin-top:0; color:#1565C0;">âœ… è¡Œå‰å·²ä»˜ (ä¸åˆ—å…¥ä¸‹æ–¹çµç®—)</h4>
            <div id="prepaid-list"></div>
        </div>

        <button class="btn-toggle-split" onclick="window.toggleSplit()">ğŸ“Š æŸ¥çœ‹åˆ†å¸³çµç®— (3äºº)</button>
        <div id="split-section">
            <div class="split-dashboard">
                <div class="split-title">åˆ†å¸³çµç®— (å¤šé€€å°‘è£œ)</div>
                <div style="text-align:center; font-size:0.9rem; color:#666; margin-bottom:10px;">
                    * ç¹³å…¬è²»ä¸è¨ˆå…¥èŠ±è²»ï¼Œä½†è¨ˆå…¥æ‚¨çš„ä»˜å‡º<br>
                    * å…¬è²»æ”¯å‡ºè¨ˆå…¥èŠ±è²»ï¼Œä½†ä¸è¨ˆå…¥å€‹äººä»˜å‡º
                </div>
                <div id="split-result-list"></div>
            </div>
        </div>
    </div>

    <div id="p-info" class="page">
        <div class="info-card">
            <h3>âœˆï¸ èˆªç­è³‡è¨Š</h3>
            <div><b>å»ç¨‹ (IT240)</b>: 1/13 06:45 TPE â” 10:00 FUK</div>
            <div style="margin-top:10px;"><b>å›ç¨‹ (IT241)</b>: 1/17 10:55 FUK â” 12:40 TPE</div>
        </div>
        <div class="info-card">
            <h3>ğŸ¨ ä½å®¿è³‡è¨Š</h3>
            <div><b>Day 1: ç”±å¸ƒé™¢å±±æ°´é¤¨</b></div>
            <div><a href="https://maps.app.goo.gl/3" target="_blank" style="color:#2196F3;">ğŸ“ é–‹å•Ÿåœ°åœ–</a></div>
            <hr style="border:0; border-top:1px dashed #eee; margin:10px 0;">
            <div><b>Day 2-4: ä¸‰äº•èŠ±åœ’é£¯åº—ç¦å²¡ä¸­æ´²</b></div>
            <div><a href="https://maps.app.goo.gl/3" target="_blank" style="color:#2196F3;">ğŸ“ é–‹å•Ÿåœ°åœ–</a></div>
        </div>
        <div class="info-card" style="border-left:5px solid red;">
            <h3>ğŸ†˜ ç·Šæ€¥è¯çµ¡</h3>
            <div style="color:red; font-weight:bold; font-size:1.2rem;">080-1004-0243</div>
            <div>æ—…å¤–åœ‹äººæ€¥é›£æ•‘åŠ©</div>
        </div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="window.resetData()" style="background:#607D8B; color:white; border:none; padding:10px; border-radius:5px;">âš ï¸ é‡ç½®è¡Œç¨‹ (ä¿®å¾©ç”¨)</button>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="window.switchPage('schedule', this)"><span class="nav-icon">ğŸ“…</span>è¡Œç¨‹</div>
        <div class="nav-item" onclick="window.switchPage('money', this)"><span class="nav-icon">ğŸ’´</span>è¨˜å¸³</div>
        <div class="nav-item" onclick="window.switchPage('info', this)"><span class="nav-icon">â„¹ï¸</span>è³‡è¨Š</div>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <div class="modal-header" id="modal-title">ç·¨è¼¯è¡Œç¨‹</div>
        <input type="hidden" id="edit-id">
        <label>æ—¥æœŸ</label>
        <select id="edit-day"><option value="Day 1">Day 1 (1/13)</option><option value="Day 2">Day 2 (1/14)</option><option value="Day 3">Day 3 (1/15)</option><option value="Day 4">Day 4 (1/16)</option><option value="Day 5">Day 5 (1/17)</option></select>
        <label>æ™‚é–“</label><input type="time" id="edit-time">
        <label>åˆ†é¡</label>
        <select id="edit-type"><option value="spot">æ™¯é» (ç¶ )</option><option value="food">ç¾é£Ÿ (æ©˜)</option><option value="trans">äº¤é€š (è—)</option></select>
        <label>æ¨™é¡Œ</label><input type="text" id="edit-title">
        <label>è©³ç´°èªªæ˜</label>
        <textarea id="edit-desc" rows="5" placeholder="å°éŠå°æ’‡æ­¥ï¼šè¼¸å…¥ã€Œå¿…åƒã€å¿…è²·ã€é ç´„ã€æœƒè‡ªå‹•äº®é¡¯å–”ï¼"></textarea>
        <label>åœ–ç‰‡é€£çµ (é¸å¡«)</label><input type="text" id="edit-img" placeholder="https://...">
        <label>ç›¸é—œé€£çµ (é¸å¡«)</label><input type="text" id="edit-link" placeholder="https://...">
        <label>Google Map åœ°é»</label><input type="text" id="edit-loc">
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="window.saveSchedule()" class="btn-submit" style="flex:1; margin:0;">å„²å­˜</button>
            <button onclick="window.closeModal()" style="flex:1; background:#ccc; border:none; border-radius:25px;">å–æ¶ˆ</button>
        </div>
        <button id="btn-del-sch" onclick="window.deleteSchedule()" style="width:100%; background:white; border:1px solid red; color:red; padding:10px; margin-top:15px; border-radius:25px;">åˆªé™¤æ­¤è¡Œç¨‹</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc, updateDoc, getDocs, writeBatch } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // â†“â†“â†“ è«‹å¡«å…¥æ‚¨çš„ Firebase Config â†“â†“â†“
const firebaseConfig = {
  apiKey: "AIzaSyDZzgq0W4xdHIhf6H1xC_dEScEHmAnXtiE",
  authDomain: "fukuokagina2026.firebaseapp.com",
  projectId: "fukuokagina2026",
  storageBucket: "fukuokagina2026.firebasestorage.app",
  messagingSenderId: "762021519656",
  appId: "1:762021519656:web:15c443c2ca2f13f9bc701d"
    };
    // â†‘â†‘â†‘ Config çµæŸ â†‘â†‘â†‘

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const RATE = 0.22;
    const PEOPLE_COUNT = 3; // åˆ†å¸³äººæ•¸

    // ç¿»è­¯
    window.openTranslate = () => {
        window.location.href = "googletranslate://"; 
        setTimeout(() => { window.open("https://translate.google.com/?sl=ja&tl=zh-TW", "_blank"); }, 500);
    };

    // --- 1. åˆå§‹è¡Œç¨‹ ---
    const initialSchedule = [
        { day: "Day 1", time: "11:45", title: "å¤§å±±ç‰›é›œé‹", type: "food", loc: "åšå¤šã‚‚ã¤é‹ãŠãŠã‚„ã¾ ç¦å²¡ç©ºæ¸¯", desc: "ã€å¿…åƒã€‘åšå¤šéˆé­‚ç¾é£Ÿï¼ç‰›è…¸è»Ÿå«©ã€å‘³å™Œæ¿ƒéƒã€‚\nä½ç½®åœ¨åœ‹å…§ç·š3Fã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0101.png", link: "https://tabelog.com/fukuoka/A4001/A400107/40047565/" },
        { day: "Day 1", time: "13:12", title: "å·´å£«å¾€ç”±å¸ƒé™¢", type: "trans", loc: "ç¦å²¡æ©Ÿå ´å·´å£«ç«™", desc: "ã€é ç´„ã€‘åœ‹å…§ç·š2è™Ÿç«™ç‰Œæ­ä¹˜ã€Œæ¹¯å¸ƒé™¢è™Ÿã€ã€‚\nè«‹å‹™å¿…ç¢ºèªçœ‹æ¿å¾€ã€Œç”±å¸ƒé™¢ã€æ–¹å‘ï¼Œè»Šç¨‹ç´„2å°æ™‚ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0102.jpg", link: "https://www.nishitetsu.jp/bus/highwaybus/rosen/yufuin/" },
        { day: "Day 1", time: "15:00", title: "å…¥ä½å±±æ°´é¤¨", type: "spot", loc: "ç”±å¸ƒé™¢å±±æ°´é¤¨", desc: "æ›ä¸Šæµ´è¡£çœ‹ç”±å¸ƒå²³å±±æ™¯ã€‚\nã€æ¨è–¦ã€‘ä¸€å®šè¦å»æ³¡éœ²å¤©æº«æ³‰ã€Œæœéœ§ä¹‹æ¹¯ã€(2F)ã€‚\næ™šé¤æ˜¯å’Œç‰›èˆ‡æ¾è‘‰èŸ¹åƒåˆ°é£½ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0103.jpg", link: "https://www.sansuikan.co.jp/" },
        { day: "Day 2", time: "10:30", title: "é‡‘é±—æ¹–", type: "spot", loc: "é‡‘é±—æ¹–", desc: "ã€å¿…æ‹ã€‘æ™¨éœ§ç¾æ™¯ï¼Œé™½å…‰ç‘è½æ™‚æ¹–é¢æ³¢å…‰ç²¼ç²¼å¦‚é‡‘é­šé±—ç‰‡ã€‚", img: "https://ginalitw.github.io/fukuoka-app/images/0104.jpg" },
        { day: "Day 2", time: "11:30", title: "æ¹¯ä¹‹åªè¡—é“", type: "food", loc: "æ¹¯ä¹‹åªè¡—é“", desc: "ã€å¿…åƒã€‘é‡‘è³å¯æ¨‚é¤…ã€B-Speakç”Ÿä¹³æ²ã€è±å¾Œç‰›é‡œé£¯ã€‚\nã€å¿…è²·ã€‘SNOOPYèŒ¶å±‹çš„é™å®šå•†å“ã€‚", img: "", link: "https://tw.wamazing.com/media/article/a-1062/" },
        { day: "Day 2", time: "17:11", title: "ç”±å¸ƒé™¢ä¹‹æ£®", type: "trans", loc: "ç”±å¸ƒé™¢é§…", desc: "ã€å¿…æ­ã€‘å¤¢å¹»ç¶ è‰²ç‰¹æ€¥åˆ—è»Šã€‚\nã€å¿…è²·ã€‘è»Šä¸Šé™å®šçš„ä¾¿ç•¶èˆ‡å¸ƒä¸ï¼Œè¨˜å¾—å»é¤è»Šè“‹ç´€å¿µç« ï¼", img: "https://ginalitw.github.io/fukuoka-app/images/0105.jpg", link: "https://www.jrkyushu.co.jp/chinese/train/yufuin_no_mori.html" },
        { day: "Day 3", time: "19:30", title: "æ°´ç‚Šé›æ™šé¤", type: "food", loc: "åšå¤šè¯å‘³é³¥", desc: "ã€å¿…åƒã€‘åšå¤šåç‰©ã€Œæ°´ç‚Šãã€ï¼Œé›æ¹¯æ¿ƒéƒå……æ»¿è† åŸè›‹ç™½ã€‚", link: "https://www.hanamidori.net/" },
        { day: "Day 4", time: "10:00", title: "å”æˆ¶å¸‚å ´", type: "food", loc: "å”æˆ¶å¸‚å ´", desc: "ã€å¿…åƒã€‘é€±äº”é™å®šã€Œé¦¬é—œè¡—ã€å£½å¸è‡ªåŠ©é¤ï¼\næ²³è±šç”Ÿé­šç‰‡å¿…è©¦ï¼Œæ–°é®®åˆä¾¿å®œã€‚", img: "https://lh5.googleusercontent.com/p/AF1QipNqR9t5C519789370603789427497127137" }
    ];

    // --- 2. è¨˜å¸³é‚è¼¯ (å…¬è²»+åˆ†å¸³) ---
    const prepaidList = [ {name:"æ©Ÿç¥¨", amt:41490}, {name:"Klook", amt:4239}, {name:"JR", amt:3862}, {name:"ä¾¿ç•¶", amt:1260} ];
    let prepaidTotal = 0;
    function initPrepaid() { let h="", t=0; prepaidList.forEach(p=>{t+=p.amt; h+=`<div class="prepaid-row"><span>${p.name}</span><b>$${p.amt.toLocaleString()}</b></div>`}); document.getElementById("prepaid-list").innerHTML=h; prepaidTotal=t; }
    initPrepaid();

    const qExp = query(collection(db, "expenses"), orderBy("timestamp", "desc"));
    onSnapshot(qExp, (snapshot) => {
        const list = document.getElementById("expense-list");
        const dashList = document.getElementById("split-result-list");
        let tripTotalCost = 0; // æ—…é€”ç¸½èŠ±è²» (å«å…¬è²»æ”¯å‡ºï¼Œä¸å«ç¹³å…¬è²»)
        let html = "";
        
        let splitMap = { "æˆ‘":0, "èŠ¬":0, "ç":0 }; // å€‹äººå·²ä»˜å‡ºé‡‘é¡ (å«ç¹³å…¬è²»ï¼Œä¸å«å…¬è²»æ”¯å‡º)

        snapshot.forEach((doc) => {
            const d = doc.data();
            let amt = Number(d.amount) || 0; 
            let curr = d.currency || "TWD";
            let payer = d.payer || "æˆ‘";
            let cat = d.category || "å…¶ä»–";
            let twd = curr === "JPY" ? Math.round(amt * RATE) : amt;
            
            // é‚è¼¯æ ¸å¿ƒï¼š
            // 1. å¦‚æœæ˜¯ã€Œç¹³å…¬è²»ã€ï¼šä¸è¨ˆå…¥ tripTotalCost (å› ç‚ºä¸æ˜¯èŠ±æ‰)ï¼Œä½†è¨ˆå…¥ payer çš„è²¢ç»
            // 2. å¦‚æœ payer æ˜¯ã€Œå…¬è²»ã€ï¼šè¨ˆå…¥ tripTotalCost (èŠ±æ‰äº†)ï¼Œä½†ä¸è¨ˆå…¥ä»»ä½•äººçš„è²¢ç» (å› ç‚ºéŒ¢æ˜¯å…¬å®¶çš„)
            // 3. ä¸€èˆ¬æƒ…æ³ï¼šè¨ˆå…¥ tripTotalCostï¼Œè¨ˆå…¥ payer è²¢ç»

            if (cat === "ç¹³å…¬è²»") {
                if (payer !== "å…¬è²»") splitMap[payer] = (splitMap[payer]||0) + twd;
            } else if (payer === "å…¬è²»") {
                tripTotalCost += twd;
            } else {
                tripTotalCost += twd;
                splitMap[payer] = (splitMap[payer]||0) + twd;
            }

            // åˆ—è¡¨é¡¯ç¤º
            let badgeClass = payer === "å…¬è²»" ? "exp-public-badge" : "exp-payer-badge";
            html += `
            <div class="expense-item">
                <div>
                    <div style="font-weight:bold;">${d.item||"æœªå‘½å"}</div>
                    <div style="font-size:0.8rem; color:#888;">${cat} Â· <span class="${badgeClass}">ğŸ‘¤ ${payer}</span></div>
                    ${d.img ? `<a href="${d.img}" target="_blank" style="font-size:0.8rem; color:#2196F3; display:block; margin-top:3px;">ğŸ“„ æŸ¥çœ‹æ”¶æ“š</a>` : ''}
                </div>
                <div style="text-align:right;">
                    <div style="color:#E91E63; font-weight:bold;">$${twd.toLocaleString()}</div>
                    ${curr==='JPY'?`<div style="font-size:0.8rem; color:#aaa;">Â¥${amt.toLocaleString()}</div>`:''}
                    <button onclick="window.delExp('${doc.id}')" style="color:red; border:none; background:none; font-size:0.8rem; margin-top:5px;">åˆªé™¤</button>
                </div>
            </div>`;
        });
        
        list.innerHTML = html || "<div style='text-align:center; color:#999;'>å°šç„¡æ–°å¢æ¶ˆè²»</div>";
        document.getElementById("total-display").innerText = "NT$ " + (prepaidTotal + tripTotalCost).toLocaleString();
        
        // --- è¨ˆç®—åˆ†å¸³ ---
        // å¹³å‡æ¯äººæ‡‰ä»˜ = (ç¸½èŠ±è²» - é ä»˜ä¸è¨ˆå…¥?) é€™è£¡åªç®—å‹•æ…‹æ–°å¢çš„éƒ¨åˆ†
        let avg = Math.round(tripTotalCost / PEOPLE_COUNT);
        let splitHtml = `<div style="text-align:center; margin-bottom:10px; font-weight:bold;">æ—…é€”ç¸½èŠ±è²»: $${tripTotalCost.toLocaleString()} <br> å¹³å‡æ¯äºº: $${avg.toLocaleString()}</div>`;
        
        const people = ["æˆ‘", "èŠ¬", "ç"];
        people.forEach(p => {
            let paid = splitMap[p] || 0;
            let balance = paid - avg;
            let color = balance >= 0 ? "split-get" : "split-owe";
            let text = balance >= 0 ? `+${balance.toLocaleString()} (æ”¶å›)` : `${balance.toLocaleString()} (éœ€ä»˜)`;
            splitHtml += `<div class="split-row"><span>ğŸ‘¤ ${p}</span><span>å·²ä»˜ $${paid.toLocaleString()} â” <span class="${color}">${text}</span></span></div>`;
        });
        dashList.innerHTML = splitHtml;
    });

    window.toggleSplit = () => {
        const el = document.getElementById("split-section");
        el.style.display = el.style.display === "block" ? "none" : "block";
        if(el.style.display === "block") el.scrollIntoView({behavior:'smooth'});
    };

    document.getElementById("btn-save-exp").addEventListener("click", async () => {
        const btn = document.getElementById("btn-save-exp"); btn.innerText="â³"; btn.disabled=true;
        try {
            const name = document.getElementById("exp-name").value; const amt = parseFloat(document.getElementById("exp-amt").value); const file = document.getElementById("exp-img-file").files[0];
            const payer = document.getElementById("exp-payer").value;
            if(!name || !amt) throw new Error("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
            let imgUrl = "";
            if(file) { const sRef = ref(storage, 'receipts/'+Date.now()+'_'+file.name); await uploadBytes(sRef, file); imgUrl = await getDownloadURL(sRef); }
            await addDoc(collection(db, "expenses"), { item: name, category: document.getElementById("exp-cat").value, payment: document.getElementById("exp-pay").value, currency: document.getElementById("exp-curr").value, amount: amt, payer: payer, img: imgUrl, timestamp: new Date() });
            document.getElementById("exp-name").value=""; document.getElementById("exp-amt").value=""; document.getElementById("img-preview").style.display="none"; alert("è¨˜å¸³æˆåŠŸ");
        } catch(e){alert(e.message)} finally { btn.innerText="è¨˜å¸³"; btn.disabled=false; }
    });

    // --- 3. è¡Œç¨‹ (é–å®š/è§£é–åŠŸèƒ½) ---
    let isLocked = true;
    window.toggleLock = () => {
        isLocked = !isLocked;
        const btn = document.getElementById("btn-lock");
        const addBtn = document.getElementById("btn-add");
        
        if(isLocked) {
            btn.classList.remove("unlocked");
            btn.innerHTML = "ğŸ”’";
            addBtn.style.display = "none";
            document.querySelectorAll(".card").forEach(c => c.classList.remove("editable"));
        } else {
            btn.classList.add("unlocked");
            btn.innerHTML = "ğŸ”“";
            addBtn.style.display = "flex";
            document.querySelectorAll(".card").forEach(c => c.classList.add("editable"));
        }
    };

    function highlight(text) {
        if(!text) return "";
        return text.replace(/(å¿…åƒ.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-food">$1</span>')
                   .replace(/(å¿…è²·.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-buy">$1</span>')
                   .replace(/(é ç´„.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-res">$1</span>')
                   .replace(/(æ¨è–¦.*?)(?=\s|$|ï¼Œ|ã€‚)/g, '<span class="hl-star">$1</span>')
                   .replace(/ã€(.*?)ã€‘/g, '<span style="color:#E91E63; font-weight:bold;">ã€$1ã€‘</span>');
    }

    const qSch = query(collection(db, "schedule"), orderBy("day"), orderBy("time"));
    onSnapshot(qSch, (snapshot) => {
        const container = document.getElementById("schedule-container");
        let html="", currentDay="";
        if(snapshot.empty) { container.innerHTML="<div style='text-align:center; padding:20px; color:#999;'>å°šç„¡è¡Œç¨‹</div>"; return; }
        
        snapshot.forEach((doc) => {
            const d = doc.data();
            if(d.day !== currentDay) { currentDay=d.day; html+=`<div class="day-divider" data-day="${d.day}">${d.day}</div>`; }
            const desc = highlight(d.desc);
            html += `<div class="card ${d.type}" data-day="${d.day}" onclick="window.cardClick('${doc.id}','${d.day}','${d.time}','${d.type}','${d.title}',\`${d.desc||''}\`,'${d.img||''}','${d.loc||''}','${d.link||''}')">
                <div style="display:flex; justify-content:space-between;"><span class="time-badge">${d.time}</span></div>
                <div class="card-title">${d.title}</div>
                <div class="card-desc">${desc}</div>
                ${d.img ? `<img src="${d.img}" class="card-img">` : ''}
                <div class="btn-group">
                    <a href="https://www.google.com/maps/search/?api=1&query=${d.loc}+ç¦å²¡" target="_blank" onclick="event.stopPropagation()" class="action-btn btn-map">ğŸ“ å°èˆª</a>
                    ${d.link ? `<a href="${d.link}" target="_blank" onclick="event.stopPropagation()" class="action-btn btn-
